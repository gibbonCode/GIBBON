
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>DEMO_febio_0031_blob_shear_contact</title><meta name="generator" content="MATLAB 9.13"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2023-04-20"><meta name="DC.source" content="DEMO_febio_0031_blob_shear_contact.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>DEMO_febio_0031_blob_shear_contact</h1><!--introduction--><p>Below is a demonstration for:</p><div><ul><li>Building geometry for a hemi-spherical blob with tetrahedral elements which is being sheared by a rigid wall. This demo consists off:</li><li>Defining the boundary conditions</li><li>Coding the febio structure</li><li>Running the model</li><li>Importing and visualizing the displacement results</li></ul></div><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Keywords</a></li><li><a href="#3">Plot settings</a></li><li><a href="#4">Control parameters</a></li><li><a href="#5">Creating model geometry and mesh</a></li><li><a href="#9">Creating rigid body ground plate</a></li><li><a href="#11">Creating rigid body shear surface</a></li><li><a href="#13">Join model node sets</a></li><li><a href="#15">Get contact surfaces</a></li><li><a href="#17">Defining the FEBio input structure</a></li><li><a href="#18">Quick viewing of the FEBio input file structure</a></li><li><a href="#20">Exporting the FEBio input file</a></li><li><a href="#21">Running the FEBio analysis</a></li><li><a href="#22">Import FEBio results</a></li></ul></div><h2 id="1">Keywords</h2><div><ul><li>febio_spec version 4.0</li><li>febio, FEBio</li><li>indentation</li><li>contact, sliding, sticky, friction</li><li>rigid body constraints</li><li>tetrahedral elements, tet4</li><li>triangular elements, tri3</li><li>slab, block, rectangular</li><li>sphere</li><li>static, solid</li><li>hyperelastic, Ogden</li><li>displacement logfile</li><li>stress logfile</li></ul></div><pre class="codeinput">clear; close <span class="string">all</span>; clc;
</pre><h2 id="3">Plot settings</h2><pre class="codeinput">fontSize=15;
faceAlpha1=0.8;
faceAlpha2=0.3;
markerSize=40;
lineWidth=3;
</pre><h2 id="4">Control parameters</h2><pre class="codeinput"><span class="comment">% Path names</span>
defaultFolder = fileparts(fileparts(mfilename(<span class="string">'fullpath'</span>)));
savePath=fullfile(defaultFolder,<span class="string">'data'</span>,<span class="string">'temp'</span>);

<span class="comment">% Defining file names</span>
febioFebFileNamePart=<span class="string">'tempModel'</span>;
febioFebFileName=fullfile(savePath,[febioFebFileNamePart,<span class="string">'.feb'</span>]); <span class="comment">%FEB file name</span>
febioLogFileName=[febioFebFileNamePart,<span class="string">'.txt'</span>]; <span class="comment">%FEBio log file name</span>
febioLogFileName_disp=[febioFebFileNamePart,<span class="string">'_disp_out.txt'</span>]; <span class="comment">%Log file name for exporting displacement</span>
<span class="comment">% febioLogFileName_force=[febioFebFileNamePart,'_force_out.txt']; %Log file name for exporting force</span>

<span class="comment">% Hemi-sphere parameters</span>
hemiSphereRadius=1;
nRefine=2;
closeOption=1;
smoothEdge=1;

<span class="comment">% Ground plate parameters</span>
plateRadius=2*hemiSphereRadius;

<span class="comment">% Probe parameters</span>
probeWidth=3*hemiSphereRadius;
filletProbe=0.25; <span class="comment">%Fillet radius</span>

<span class="comment">% Define probe displacement</span>
probeDisplacement=hemiSphereRadius*2;
probeOverlapFactor=0.4;

<span class="comment">% Material parameter set</span>
c1=1e-3; <span class="comment">%Shear-modulus-like parameter</span>
m1=2; <span class="comment">%Material parameter setting degree of non-linearity</span>
k_factor=10; <span class="comment">%Bulk modulus factor</span>
k=c1*k_factor; <span class="comment">%Bulk modulus</span>

<span class="comment">% FEA control settings</span>
numTimeSteps=30;
max_refs=25; <span class="comment">%Max reforms</span>
max_ups=0; <span class="comment">%Set to zero to use full-Newton iterations</span>
opt_iter=10; <span class="comment">%Optimum number of iterations</span>
max_retries=25; <span class="comment">%Maximum number of retires</span>
symmetric_stiffness=0;
min_residual=1e-20;
step_size=1/numTimeSteps;
dtmin=(1/numTimeSteps)/100; <span class="comment">%Minimum time step size</span>
dtmax=(1/(numTimeSteps)); <span class="comment">%Maximum time step size</span>

runMode=<span class="string">'external'</span>;<span class="comment">% 'internal' or 'external'</span>

<span class="comment">%Contact parameters</span>
contactPenalty=1;
laugon=0;
minaug=1;
maxaug=10;
fric_coeff=0.01;
max_traction=0;
</pre><h2 id="5">Creating model geometry and mesh</h2><pre class="codeinput"><span class="comment">% Create hemi-sphere mesh</span>
[F_blob,V_blob,C_blob]=hemiSphereMesh(nRefine,hemiSphereRadius,1);
pointSpacingBlob=mean(patchEdgeLengths(F_blob,V_blob));

<span class="comment">%Smoothen edges</span>
<span class="keyword">if</span> smoothEdge==1
    <span class="comment">%Get rigid region</span>
    ind=1:1:size(V_blob,1); <span class="comment">%Indices for all nodes</span>
    indRigid=find(ismember(ind,F_blob(C_blob==2,:)) &amp; ~ismember(ind,F_blob(C_blob==1,:))); <span class="comment">%Indices for new bottom surface nodes</span>

    <span class="comment">%Smoothing</span>
    cPar.Method=<span class="string">'HC'</span>;
    cPar.n=250;
    cPar.RigidConstraints=indRigid;
    [V_blob]=patchSmooth(F_blob,V_blob,[],cPar);

    <span class="comment">%Fix color data with new bottom surface</span>
    C_blob=ones(size(C_blob));
    C_blob(all(ismember(F_blob,indRigid),2))=2;

<span class="keyword">end</span>
</pre><p>Visualize hemi-sphere surface</p><pre class="codeinput">cFigure; hold <span class="string">on</span>;
gtitle(<span class="string">'The hemi-sphere surface mesh'</span>,fontSize);
gpatch(F_blob,V_blob,C_blob,<span class="string">'k'</span>,0.85);
patchNormPlot(F_blob,V_blob);
axisGeom(gca,fontSize);
colormap(gjet); icolorbar;
camlight <span class="string">headlight</span>;
drawnow;
</pre><img width="100%" height="auto" vspace="5" hspace="5" src="DEMO_febio_0031_blob_shear_contact_01.jpg" alt=""> <p>Using tetgen to create a tetrahedral mesh</p><pre class="codeinput"><span class="comment">% Tetgen input structure</span>
inputStruct.stringOpt=<span class="string">'-pq1.2AaY'</span>;
inputStruct.Faces=F_blob;
inputStruct.Nodes=V_blob;
inputStruct.holePoints=[];
inputStruct.faceBoundaryMarker=C_blob; <span class="comment">%Face boundary markers</span>
inputStruct.regionPoints=getInnerPoint(F_blob,V_blob); <span class="comment">%region points</span>
inputStruct.regionA=tetVolMeanEst(F_blob,V_blob);
inputStruct.minRegionMarker=2; <span class="comment">%Minimum region marker</span>

<span class="comment">% Create tetrahedral mesh using tetGen</span>
[meshOutput]=runTetGen(inputStruct); <span class="comment">%Run tetGen</span>

<span class="comment">% Access model element and patch data</span>
Fb_blob=fliplr(meshOutput.facesBoundary);
Cb_blob=meshOutput.boundaryMarker;
V_blob=meshOutput.nodes;
E_blob=meshOutput.elements;
</pre><pre class="codeoutput"> 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
--- TETGEN Tetrahedral meshing --- 20-Apr-2023 11:35:54
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
--- Writing SMESH file --- 20-Apr-2023 11:35:54
----&gt; Adding node field
----&gt; Adding facet field
----&gt; Adding holes specification
----&gt; Adding region specification
--- Done --- 20-Apr-2023 11:35:54
--- Running TetGen to mesh input boundary--- 20-Apr-2023 11:35:54
Opening /mnt/data/MATLAB/GIBBON/data/temp/temp.smesh.
Delaunizing vertices...
Delaunay seconds:  0.002067
Creating surface mesh ...
Surface mesh seconds:  0.000757
Recovering boundaries...
Boundary recovery seconds:  0.000926
Removing exterior tetrahedra ...
Spreading region attributes.
Exterior tets removal seconds:  0.00028
Recovering Delaunayness...
Delaunay recovery seconds:  0.000508
Refining mesh...
  634 insertions, added 526 points, 16457 tetrahedra in queue.
  211 insertions, added 164 points, 19804 tetrahedra in queue.
  281 insertions, added 193 points, 22682 tetrahedra in queue.
  374 insertions, added 195 points, 19304 tetrahedra in queue.
  499 insertions, added 99 points, 452 tetrahedra in queue.
Refinement seconds:  0.022635
Smoothing vertices...
Mesh smoothing seconds:  0.042211
Improving mesh...
Mesh improvement seconds:  0.00171

Writing /mnt/data/MATLAB/GIBBON/data/temp/temp.1.node.
Writing /mnt/data/MATLAB/GIBBON/data/temp/temp.1.ele.
Writing /mnt/data/MATLAB/GIBBON/data/temp/temp.1.face.
Writing /mnt/data/MATLAB/GIBBON/data/temp/temp.1.edge.

Output seconds:  0.014534
Total running seconds:  0.085729

Statistics:

  Input points: 476
  Input facets: 948
  Input segments: 1422
  Input holes: 0
  Input regions: 1

  Mesh points: 1662
  Mesh tetrahedra: 8647
  Mesh faces: 17768
  Mesh faces on exterior boundary: 948
  Mesh faces on input facets: 948
  Mesh edges on input segments: 1422
  Steiner points inside domain: 1186

--- Done --- 20-Apr-2023 11:35:54
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
--- Importing TetGen files --- 20-Apr-2023 11:35:54
--- Done --- 20-Apr-2023 11:35:54
</pre><p>Visualize blob mesh</p><pre class="codeinput">hFig=cFigure;
subplot(1,2,1); hold <span class="string">on</span>;
gpatch(Fb_blob,V_blob,Cb_blob,<span class="string">'k'</span>,1);
patchNormPlot(Fb_blob,V_blob);
axisGeom(gca,fontSize);
colormap(gjet); icolorbar;
camlight <span class="string">headlight</span>;

hs=subplot(1,2,2); hold <span class="string">on</span>;
title(<span class="string">'Cut view of solid mesh'</span>,<span class="string">'FontSize'</span>,fontSize);
optionStruct.hFig=[hFig hs];
gpatch(Fb_blob,V_blob,<span class="string">'kw'</span>,<span class="string">'none'</span>,0.25);
meshView(meshOutput,optionStruct);
axisGeom(gca,fontSize);
drawnow;
</pre><img width="100%" height="auto" vspace="5" hspace="5" src="DEMO_febio_0031_blob_shear_contact_02.jpg" alt=""> <h2 id="9">Creating rigid body ground plate</h2><pre class="codeinput"><span class="comment">%Get outer surve of ground surface</span>
[Eb]=patchBoundary(Fb_blob(Cb_blob==2,:));
indCurveBottom=edgeListToCurve(Eb);
indCurveBottom=indCurveBottom(1:end-1);

<span class="comment">% Derive point spacing for plate</span>
pointSpacingPlate=pointSpacingBlob;

<span class="comment">% Compose outer curve of the plate</span>
nPlateCurve=ceil((2*pi*plateRadius)/pointSpacingPlate);
t=linspace(0,2*pi,nPlateCurve);
t=t(1:end-1);
x=plateRadius.*sin(t);
y=plateRadius.*cos(t);
Vp_outer_curve=[x(:) y(:)];

<span class="comment">% Copy inner curve from the hemi-sphere</span>
Vp_inner_curve=V_blob(indCurveBottom,[1 2]);

<span class="comment">% Create mesh out outer region</span>
regionCell={Vp_outer_curve,Vp_inner_curve};
[F_plate,V_plate]=regionTriMesh2D(regionCell,pointSpacingPlate,0,0);
V_plate(:,3)=0; <span class="comment">%Add z-direction</span>

<span class="comment">% Copy mesh for inner region</span>
[F_plate_inner,V_plate_inner]=patchCleanUnused(fliplr(Fb_blob(Cb_blob==2,:)),V_blob);
[F_plate,V_plate,C_plate]=joinElementSets({F_plate,F_plate_inner},{V_plate,V_plate_inner});
[F_plate,V_plate]=mergeVertices(F_plate,V_plate);

center_of_mass_plate=mean(V_plate,1);
</pre><p>Visualizing plate mesh</p><pre class="codeinput">cFigure; hold <span class="string">on</span>;
gtitle(<span class="string">'The plate surface mesh'</span>,fontSize);
gpatch(Fb_blob,V_blob,<span class="string">'kw'</span>,<span class="string">'none'</span>,0.5);
gpatch(F_plate,V_plate,C_plate,<span class="string">'k'</span>,1);
patchNormPlot(F_plate,V_plate);
axisGeom(gca,fontSize);
colormap(gjet); icolorbar;
camlight <span class="string">headlight</span>;
drawnow;
</pre><img width="100%" height="auto" vspace="5" hspace="5" src="DEMO_febio_0031_blob_shear_contact_03.jpg" alt=""> <img width="100%" height="auto" vspace="5" hspace="5" src="DEMO_febio_0031_blob_shear_contact_04.jpg" alt=""> <h2 id="11">Creating rigid body shear surface</h2><pre class="codeinput">pointSpacingProbe=pointSpacingBlob/2;

<span class="comment">%Sketching side profile</span>
x=[-hemiSphereRadius hemiSphereRadius hemiSphereRadius]-hemiSphereRadius*2;
y=[0 0 0];
z=[hemiSphereRadius*(1-probeOverlapFactor) hemiSphereRadius*(1-probeOverlapFactor) hemiSphereRadius*1.5];
V_probe_curve_sketch=[x(:) y(:) z(:)];

<span class="comment">%Fillet sketch</span>
np=100; <span class="comment">%Number of points used to construct each fillet edge</span>
[V_probe_curve]=filletCurve(V_probe_curve_sketch,filletProbe,np,0);
numPointsProbeCurve=ceil(max(pathLength(V_probe_curve))/pointSpacingProbe);
[V_probe_curve] = evenlySampleCurve(V_probe_curve,numPointsProbeCurve,<span class="string">'pchip'</span>,0);

<span class="comment">% Extruding curve</span>
<span class="comment">% controlParametersExtrude.pointSpacing=pointSpacingProbe;</span>
controlParametersExtrude.depth=hemiSphereRadius*2.5;
controlParametersExtrude.numSteps=ceil(controlParametersExtrude.depth/pointSpacingProbe);
controlParametersExtrude.numSteps=controlParametersExtrude.numSteps+iseven(controlParametersExtrude.numSteps); <span class="comment">%Force uneven</span>
controlParametersExtrude.patchType=<span class="string">'tri'</span>;
controlParametersExtrude.dir=0;
controlParametersExtrude.n=[0 1 0];
controlParametersExtrude.closeLoopOpt=0;

[F_probe,V_probe]=polyExtrude(V_probe_curve,controlParametersExtrude);
F_probe=fliplr(F_probe); <span class="comment">%Invert face orientation so normals point to blob</span>

center_of_mass_probe=mean(V_probe,1);
</pre><p>Visualizing probe mesh</p><pre class="codeinput">cFigure; hold <span class="string">on</span>;
title(<span class="string">'The probe surface mesh'</span>,<span class="string">'fontSize'</span>,fontSize);
gpatch(Fb_blob,V_blob,<span class="string">'kw'</span>,<span class="string">'none'</span>,0.5);
gpatch(F_plate,V_plate,<span class="string">'kw'</span>,<span class="string">'none'</span>,0.5);
hl(1)=plotV(V_probe_curve_sketch,<span class="string">'k.-.'</span>,<span class="string">'lineWidth'</span>,3,<span class="string">'MarkerSize'</span>,25);
hl(2)=plotV(V_probe_curve,<span class="string">'r-'</span>,<span class="string">'lineWidth'</span>,3,<span class="string">'MarkerSize'</span>,25);
hl(3)=gpatch(F_probe,V_probe,<span class="string">'gw'</span>,<span class="string">'k'</span>,1);
legend(hl,{<span class="string">'Sketched probe curve'</span>,<span class="string">'Rounded probe curve'</span>,<span class="string">'Probe surface mesh'</span>}); clear <span class="string">hl</span>;
axisGeom(gca,fontSize);
camlight <span class="string">headlight</span>;
drawnow;
</pre><img width="100%" height="auto" vspace="5" hspace="5" src="DEMO_febio_0031_blob_shear_contact_05.jpg" alt=""> <h2 id="13">Join model node sets</h2><pre class="codeinput">V=[V_blob; V_plate; V_probe];
F_plate=F_plate+size(V_blob,1);
F_probe=F_probe+size(V_blob,1)+size(V_plate,1);
Fb_all=[Fb_blob;F_plate;F_probe];
</pre><p>Visualizing model</p><pre class="codeinput">cFigure; hold <span class="string">on</span>;
gtitle(<span class="string">'Model components'</span>,fontSize);
hl(1)=gpatch(Fb_blob,V,<span class="string">'rw'</span>,<span class="string">'k'</span>,0.8);
hl(2)=gpatch(F_plate,V,<span class="string">'bw'</span>,<span class="string">'k'</span>,0.8);
hl(3)=gpatch(F_probe,V,<span class="string">'gw'</span>,<span class="string">'k'</span>,0.8);
legend(hl,{<span class="string">'Blob'</span>,<span class="string">'Plate'</span>,<span class="string">'Probe'</span>}); clear <span class="string">hl</span>;
axisGeom(gca,fontSize);
camlight <span class="string">headlight</span>;
drawnow;
</pre><img width="100%" height="auto" vspace="5" hspace="5" src="DEMO_febio_0031_blob_shear_contact_06.jpg" alt=""> <h2 id="15">Get contact surfaces</h2><pre class="codeinput"><span class="comment">% F_contact_blob1=Fb_blob(Cb_blob==1,:);</span>
<span class="comment">% F_contact_blob2=Fb_blob(Cb_blob==2,:);</span>
</pre><p>Visualize contact surfaces</p><pre class="codeinput">cFigure;
subplot(1,2,1); hold <span class="string">on</span>;
title(<span class="string">'Probe blob contact pair'</span>,<span class="string">'fontsize'</span>,fontSize);
hl(1)=gpatch(F_probe,V,<span class="string">'rw'</span>,<span class="string">'k'</span>,1);
patchNormPlot(F_probe,V);
hl(2)=gpatch(Fb_blob,V,<span class="string">'gw'</span>,<span class="string">'k'</span>,1);
patchNormPlot(Fb_blob,V);
legend(hl,{<span class="string">'secondary'</span>,<span class="string">'primary'</span>}); clear <span class="string">hl</span>;
axisGeom(gca,fontSize);
camlight <span class="string">headlight</span>;

subplot(1,2,2); hold <span class="string">on</span>;
title(<span class="string">'Plate blob contact pair'</span>,<span class="string">'fontsize'</span>,fontSize);
hl(1)=gpatch(F_plate,V,<span class="string">'rw'</span>,<span class="string">'k'</span>,1);
patchNormPlot(F_plate,V);
hl(2)=gpatch(Fb_blob,V,<span class="string">'gw'</span>,<span class="string">'k'</span>,1);
patchNormPlot(Fb_blob,V);
legend(hl,{<span class="string">'secondary'</span>,<span class="string">'primary'</span>}); clear <span class="string">hl</span>;
axisGeom(gca,fontSize);
camlight <span class="string">headlight</span>;

drawnow;
</pre><img width="100%" height="auto" vspace="5" hspace="5" src="DEMO_febio_0031_blob_shear_contact_07.jpg" alt=""> <h2 id="17">Defining the FEBio input structure</h2><p>See also <tt>febioStructTemplate</tt> and <tt>febioStruct2xml</tt> and the FEBio user manual.</p><pre class="codeinput"><span class="comment">%Get a template with default settings</span>
[febio_spec]=febioStructTemplate;

<span class="comment">%febio_spec version</span>
febio_spec.ATTR.version=<span class="string">'4.0'</span>;

<span class="comment">%Module section</span>
febio_spec.Module.ATTR.type=<span class="string">'solid'</span>;

<span class="comment">%Control section</span>
febio_spec.Control.analysis=<span class="string">'STATIC'</span>;
febio_spec.Control.time_steps=numTimeSteps;
febio_spec.Control.step_size=1/numTimeSteps;
febio_spec.Control.solver.max_refs=max_refs;
febio_spec.Control.solver.qn_method.max_ups=max_ups;
febio_spec.Control.solver.symmetric_stiffness=symmetric_stiffness;
febio_spec.Control.time_stepper.dtmin=dtmin;
febio_spec.Control.time_stepper.dtmax=dtmax;
febio_spec.Control.time_stepper.max_retries=max_retries;
febio_spec.Control.time_stepper.opt_iter=opt_iter;

<span class="comment">%Material section</span>
materialName1=<span class="string">'Material1'</span>;
febio_spec.Material.material{1}.ATTR.name=materialName1;
febio_spec.Material.material{1}.ATTR.type=<span class="string">'Ogden'</span>;
febio_spec.Material.material{1}.ATTR.id=1;
febio_spec.Material.material{1}.c1=c1;
febio_spec.Material.material{1}.m1=m1;
febio_spec.Material.material{1}.c2=c1;
febio_spec.Material.material{1}.m2=-m1;
febio_spec.Material.material{1}.k=k;

materialName2=<span class="string">'Material2'</span>;
febio_spec.Material.material{2}.ATTR.name=materialName2;
febio_spec.Material.material{2}.ATTR.type=<span class="string">'rigid body'</span>;
febio_spec.Material.material{2}.ATTR.id=2;
febio_spec.Material.material{2}.density=1;
febio_spec.Material.material{2}.center_of_mass=center_of_mass_plate;

materialName3=<span class="string">'Material3'</span>;
febio_spec.Material.material{3}.ATTR.name=materialName3;
febio_spec.Material.material{3}.ATTR.type=<span class="string">'rigid body'</span>;
febio_spec.Material.material{3}.ATTR.id=3;
febio_spec.Material.material{3}.density=1;
febio_spec.Material.material{3}.center_of_mass=center_of_mass_probe;

<span class="comment">%Mesh section</span>
<span class="comment">% -&gt; Nodes</span>
febio_spec.Mesh.Nodes{1}.ATTR.name=<span class="string">'nodeSet_all'</span>; <span class="comment">%The node set name</span>
febio_spec.Mesh.Nodes{1}.node.ATTR.id=(1:size(V,1))'; <span class="comment">%The node id's</span>
febio_spec.Mesh.Nodes{1}.node.VAL=V; <span class="comment">%The nodel coordinates</span>

<span class="comment">% -&gt; Elements</span>
partName1=<span class="string">'Part1'</span>;
febio_spec.Mesh.Elements{1}.ATTR.name=partName1; <span class="comment">%Name of this part</span>
febio_spec.Mesh.Elements{1}.ATTR.type=<span class="string">'tet4'</span>; <span class="comment">%Element type</span>
febio_spec.Mesh.Elements{1}.elem.ATTR.id=(1:1:size(E_blob,1))'; <span class="comment">%Element id's</span>
febio_spec.Mesh.Elements{1}.elem.VAL=E_blob; <span class="comment">%The element matrix</span>

partName2=<span class="string">'Part2'</span>;
febio_spec.Mesh.Elements{2}.ATTR.name=partName2; <span class="comment">%Name of this part</span>
febio_spec.Mesh.Elements{2}.ATTR.type=<span class="string">'tri3'</span>; <span class="comment">%Element type</span>
febio_spec.Mesh.Elements{2}.elem.ATTR.id=size(E_blob,1)+(1:1:size(F_plate,1))'; <span class="comment">%Element id's</span>
febio_spec.Mesh.Elements{2}.elem.VAL=F_plate;

partName3=<span class="string">'Part3'</span>;
febio_spec.Mesh.Elements{3}.ATTR.name=partName3; <span class="comment">%Name of this part</span>
febio_spec.Mesh.Elements{3}.ATTR.type=<span class="string">'tri3'</span>; <span class="comment">%Element type</span>
febio_spec.Mesh.Elements{3}.elem.ATTR.id=size(E_blob,1)+size(F_plate,1)+(1:1:size(F_probe,1))'; <span class="comment">%Element id's</span>
febio_spec.Mesh.Elements{3}.elem.VAL=F_probe;

<span class="comment">%MeshDomains section</span>
febio_spec.MeshDomains.SolidDomain{1}.ATTR.name=partName1;
febio_spec.MeshDomains.SolidDomain{1}.ATTR.mat=materialName1;

febio_spec.MeshDomains.ShellDomain{1}.ATTR.name=partName2;
febio_spec.MeshDomains.ShellDomain{1}.ATTR.mat=materialName2;

febio_spec.MeshDomains.ShellDomain{2}.ATTR.name=partName3;
febio_spec.MeshDomains.ShellDomain{2}.ATTR.mat=materialName3;

<span class="comment">% % -&gt; Surfaces</span>
surfaceName1=<span class="string">'contactSurface1'</span>;
febio_spec.Mesh.Surface{1}.ATTR.name=surfaceName1;
febio_spec.Mesh.Surface{1}.tri3.ATTR.id=(1:1:size(F_plate,1))';
febio_spec.Mesh.Surface{1}.tri3.VAL=F_plate;

surfaceName2=<span class="string">'contactSurface2'</span>;
febio_spec.Mesh.Surface{2}.ATTR.name=surfaceName2;
febio_spec.Mesh.Surface{2}.tri3.ATTR.id=(1:1:size(Fb_blob,1))';
febio_spec.Mesh.Surface{2}.tri3.VAL=Fb_blob;

surfaceName3=<span class="string">'contactSurface3'</span>;
febio_spec.Mesh.Surface{3}.ATTR.name=surfaceName3;
febio_spec.Mesh.Surface{3}.tri3.ATTR.id=(1:1:size(F_probe,1))';
febio_spec.Mesh.Surface{3}.tri3.VAL=F_probe;

surfaceName4=<span class="string">'contactSurface4'</span>;
febio_spec.Mesh.Surface{4}.ATTR.name=surfaceName4;
febio_spec.Mesh.Surface{4}.tri3.ATTR.id=(1:1:size(Fb_blob(Cb_blob==1,:),1))';
febio_spec.Mesh.Surface{4}.tri3.VAL=Fb_blob(Cb_blob==1,:);

<span class="comment">% -&gt; Surface pairs</span>
contactPairName1=<span class="string">'Contact1'</span>;
febio_spec.Mesh.SurfacePair{1}.ATTR.name=contactPairName1;
febio_spec.Mesh.SurfacePair{1}.primary=surfaceName2;
febio_spec.Mesh.SurfacePair{1}.secondary=surfaceName1;

contactPairName2=<span class="string">'Contact2'</span>;
febio_spec.Mesh.SurfacePair{2}.ATTR.name=contactPairName2;
febio_spec.Mesh.SurfacePair{2}.primary=surfaceName4;
febio_spec.Mesh.SurfacePair{2}.secondary=surfaceName3;

<span class="comment">%Rigid section</span>
<span class="comment">% -&gt;Rigid body fix boundary conditions</span>
febio_spec.Rigid.rigid_bc{1}.ATTR.name=<span class="string">'RigidFix_1'</span>;
febio_spec.Rigid.rigid_bc{1}.ATTR.type=<span class="string">'rigid_fixed'</span>;
febio_spec.Rigid.rigid_bc{1}.rb=2;
febio_spec.Rigid.rigid_bc{1}.Rx_dof=1;
febio_spec.Rigid.rigid_bc{1}.Ry_dof=1;
febio_spec.Rigid.rigid_bc{1}.Rz_dof=1;
febio_spec.Rigid.rigid_bc{1}.Ru_dof=1;
febio_spec.Rigid.rigid_bc{1}.Rv_dof=1;
febio_spec.Rigid.rigid_bc{1}.Rw_dof=1;

febio_spec.Rigid.rigid_bc{2}.ATTR.name=<span class="string">'RigidFix_2'</span>;
febio_spec.Rigid.rigid_bc{2}.ATTR.type=<span class="string">'rigid_fixed'</span>;
febio_spec.Rigid.rigid_bc{2}.rb=3;
<span class="comment">% febio_spec.Rigid.rigid_bc{2}.Rx_dof=1;</span>
febio_spec.Rigid.rigid_bc{2}.Ry_dof=1;
febio_spec.Rigid.rigid_bc{2}.Rz_dof=1;
febio_spec.Rigid.rigid_bc{2}.Ru_dof=1;
febio_spec.Rigid.rigid_bc{2}.Rv_dof=1;
febio_spec.Rigid.rigid_bc{2}.Rw_dof=1;

<span class="comment">% -&gt;Rigid body prescribe boundary conditions</span>
febio_spec.Rigid.rigid_bc{3}.ATTR.name=<span class="string">'RigidPrescribe'</span>;
febio_spec.Rigid.rigid_bc{3}.ATTR.type=<span class="string">'rigid_displacement'</span>;
febio_spec.Rigid.rigid_bc{3}.rb=3;
febio_spec.Rigid.rigid_bc{3}.dof=<span class="string">'x'</span>;
febio_spec.Rigid.rigid_bc{3}.value.ATTR.lc=1;
febio_spec.Rigid.rigid_bc{3}.value.VAL=probeDisplacement;
febio_spec.Rigid.rigid_bc{3}.relative=0;

<span class="comment">%Contact section</span>
<span class="comment">% -&gt; Contact 1</span>
febio_spec.Contact.contact{1}.ATTR.type=<span class="string">'sticky'</span>;
febio_spec.Contact.contact{1}.ATTR.surface_pair=contactPairName1;
febio_spec.Contact.contact{1}.penalty=10;
febio_spec.Contact.contact{1}.laugon=0;
febio_spec.Contact.contact{1}.tolerance=0.1;
febio_spec.Contact.contact{1}.minaug=1;
febio_spec.Contact.contact{1}.maxaug=10;
febio_spec.Contact.contact{1}.snap_tol=0;
febio_spec.Contact.contact{1}.max_traction=max_traction;
febio_spec.Contact.contact{1}.search_tolerance=0.1;

febio_spec.Contact.contact{2}.ATTR.type=<span class="string">'sliding-elastic'</span>;
febio_spec.Contact.contact{2}.ATTR.surface_pair=contactPairName2;
febio_spec.Contact.contact{2}.two_pass=0;
febio_spec.Contact.contact{2}.laugon=laugon;
febio_spec.Contact.contact{2}.tolerance=0.2;
febio_spec.Contact.contact{2}.gaptol=0;
febio_spec.Contact.contact{2}.minaug=minaug;
febio_spec.Contact.contact{2}.maxaug=maxaug;
febio_spec.Contact.contact{2}.search_tol=0.01;
febio_spec.Contact.contact{2}.search_radius=0.1*sqrt(sum((max(V,[],1)-min(V,[],1)).^2,2));
febio_spec.Contact.contact{2}.symmetric_stiffness=0;
febio_spec.Contact.contact{2}.auto_penalty=1;
febio_spec.Contact.contact{2}.penalty=contactPenalty;
febio_spec.Contact.contact{2}.fric_coeff=fric_coeff;

<span class="comment">%LoadData section</span>
<span class="comment">% -&gt; load_controller</span>
febio_spec.LoadData.load_controller{1}.ATTR.name=<span class="string">'LC_1'</span>;
febio_spec.LoadData.load_controller{1}.ATTR.id=1;
febio_spec.LoadData.load_controller{1}.ATTR.type=<span class="string">'loadcurve'</span>;
febio_spec.LoadData.load_controller{1}.interpolate=<span class="string">'LINEAR'</span>;
<span class="comment">%febio_spec.LoadData.load_controller{1}.extend='CONSTANT';</span>
febio_spec.LoadData.load_controller{1}.points.pt.VAL=[0 0; 1 1];

<span class="comment">%Output section</span>
<span class="comment">% -&gt; log file</span>
febio_spec.Output.logfile.ATTR.file=febioLogFileName;
febio_spec.Output.logfile.node_data{1}.ATTR.file=febioLogFileName_disp;
febio_spec.Output.logfile.node_data{1}.ATTR.data=<span class="string">'ux;uy;uz'</span>;
febio_spec.Output.logfile.node_data{1}.ATTR.delim=<span class="string">','</span>;
</pre><h2 id="18">Quick viewing of the FEBio input file structure</h2><p>The <tt>febView</tt> function can be used to view the xml structure in a MATLAB figure window.</p><p><tt>febView(febio_spec); %Viewing the febio file</tt></p><h2 id="20">Exporting the FEBio input file</h2><p>Exporting the febio_spec structure to an FEBio input file is done using the <tt>febioStruct2xml</tt> function.</p><pre class="codeinput">febioStruct2xml(febio_spec,febioFebFileName); <span class="comment">%Exporting to file and domNode</span>
</pre><h2 id="21">Running the FEBio analysis</h2><p>To run the analysis defined by the created FEBio input file the <tt>runMonitorFEBio</tt> function is used. The input for this function is a structure defining job settings e.g. the FEBio input file name. The optional output runFlag informs the user if the analysis was run succesfully.</p><pre class="codeinput">febioAnalysis.run_filename=febioFebFileName; <span class="comment">%The input file name</span>
febioAnalysis.run_logname=febioLogFileName; <span class="comment">%The name for the log file</span>
febioAnalysis.disp_on=1; <span class="comment">%Display information on the command window</span>
febioAnalysis.runMode=<span class="string">'external'</span>;<span class="comment">%'internal';</span>

[runFlag]=runMonitorFEBio(febioAnalysis);<span class="comment">%START FEBio NOW!!!!!!!!</span>
</pre><pre class="codeoutput"> 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
--------&gt;    RUNNING/MONITORING FEBIO JOB    &lt;-------- 20-Apr-2023 11:36:05
FEBio path: /home/kevin/FEBioStudio2/bin/febio4
# Attempt removal of existing log files                20-Apr-2023 11:36:05
 * Removal succesful                                   20-Apr-2023 11:36:05
# Attempt removal of existing .xplt files              20-Apr-2023 11:36:05
 * Removal succesful                                   20-Apr-2023 11:36:05
# Starting FEBio...                                    20-Apr-2023 11:36:05
  Max. total analysis time is: Inf s
 * Waiting for log file creation                       20-Apr-2023 11:36:05
   Max. wait time: 30 s
 * Log file found.                                     20-Apr-2023 11:36:05
# Parsing log file...                                  20-Apr-2023 11:36:05
    number of reformations : 1                         20-Apr-2023 11:36:06
------- converged at time : 0.0333333                  20-Apr-2023 11:36:06
    number of iterations   : 1                         20-Apr-2023 11:36:06
    number of reformations : 1                         20-Apr-2023 11:36:06
------- converged at time : 0.0666667                  20-Apr-2023 11:36:06
    number of iterations   : 1                         20-Apr-2023 11:36:06
    number of reformations : 1                         20-Apr-2023 11:36:06
------- converged at time : 0.1                        20-Apr-2023 11:36:06
    number of iterations   : 1                         20-Apr-2023 11:36:06
    number of reformations : 1                         20-Apr-2023 11:36:06
------- converged at time : 0.133333                   20-Apr-2023 11:36:06
    number of iterations   : 1                         20-Apr-2023 11:36:07
    number of reformations : 1                         20-Apr-2023 11:36:07
------- converged at time : 0.166667                   20-Apr-2023 11:36:07
    number of iterations   : 5                         20-Apr-2023 11:36:07
    number of reformations : 5                         20-Apr-2023 11:36:07
------- converged at time : 0.2                        20-Apr-2023 11:36:07
    number of iterations   : 5                         20-Apr-2023 11:36:08
    number of reformations : 5                         20-Apr-2023 11:36:08
------- converged at time : 0.233333                   20-Apr-2023 11:36:08
    number of iterations   : 5                         20-Apr-2023 11:36:08
    number of reformations : 5                         20-Apr-2023 11:36:08
------- converged at time : 0.266667                   20-Apr-2023 11:36:08
    number of iterations   : 5                         20-Apr-2023 11:36:09
    number of reformations : 5                         20-Apr-2023 11:36:09
------- converged at time : 0.3                        20-Apr-2023 11:36:09
    number of iterations   : 6                         20-Apr-2023 11:36:09
    number of reformations : 6                         20-Apr-2023 11:36:09
------- converged at time : 0.333333                   20-Apr-2023 11:36:09
    number of iterations   : 6                         20-Apr-2023 11:36:10
    number of reformations : 6                         20-Apr-2023 11:36:10
------- converged at time : 0.366667                   20-Apr-2023 11:36:10
    number of iterations   : 6                         20-Apr-2023 11:36:11
    number of reformations : 6                         20-Apr-2023 11:36:11
------- converged at time : 0.4                        20-Apr-2023 11:36:11
    number of iterations   : 6                         20-Apr-2023 11:36:12
    number of reformations : 6                         20-Apr-2023 11:36:12
------- converged at time : 0.433333                   20-Apr-2023 11:36:12
    number of iterations   : 6                         20-Apr-2023 11:36:13
    number of reformations : 6                         20-Apr-2023 11:36:13
------- converged at time : 0.466667                   20-Apr-2023 11:36:13
    number of iterations   : 6                         20-Apr-2023 11:36:13
    number of reformations : 6                         20-Apr-2023 11:36:13
------- converged at time : 0.5                        20-Apr-2023 11:36:13
    number of iterations   : 6                         20-Apr-2023 11:36:14
    number of reformations : 6                         20-Apr-2023 11:36:14
------- converged at time : 0.533333                   20-Apr-2023 11:36:14
    number of iterations   : 7                         20-Apr-2023 11:36:15
    number of reformations : 7                         20-Apr-2023 11:36:15
------- converged at time : 0.566667                   20-Apr-2023 11:36:15
    number of iterations   : 7                         20-Apr-2023 11:36:15
    number of reformations : 7                         20-Apr-2023 11:36:15
------- converged at time : 0.6                        20-Apr-2023 11:36:15
    number of iterations   : 7                         20-Apr-2023 11:36:16
    number of reformations : 7                         20-Apr-2023 11:36:16
------- converged at time : 0.633333                   20-Apr-2023 11:36:16
    number of iterations   : 7                         20-Apr-2023 11:36:17
    number of reformations : 7                         20-Apr-2023 11:36:17
------- converged at time : 0.666667                   20-Apr-2023 11:36:17
    number of iterations   : 7                         20-Apr-2023 11:36:18
    number of reformations : 7                         20-Apr-2023 11:36:18
------- converged at time : 0.7                        20-Apr-2023 11:36:18
    number of iterations   : 6                         20-Apr-2023 11:36:19
    number of reformations : 6                         20-Apr-2023 11:36:19
------- converged at time : 0.733333                   20-Apr-2023 11:36:19
    number of iterations   : 7                         20-Apr-2023 11:36:20
    number of reformations : 7                         20-Apr-2023 11:36:20
------- converged at time : 0.766667                   20-Apr-2023 11:36:20
    number of iterations   : 6                         20-Apr-2023 11:36:21
    number of reformations : 6                         20-Apr-2023 11:36:21
------- converged at time : 0.8                        20-Apr-2023 11:36:21
    number of iterations   : 6                         20-Apr-2023 11:36:21
    number of reformations : 6                         20-Apr-2023 11:36:21
------- converged at time : 0.833333                   20-Apr-2023 11:36:21
    number of iterations   : 6                         20-Apr-2023 11:36:22
    number of reformations : 6                         20-Apr-2023 11:36:22
------- converged at time : 0.866667                   20-Apr-2023 11:36:22
    number of iterations   : 6                         20-Apr-2023 11:36:23
    number of reformations : 6                         20-Apr-2023 11:36:23
------- converged at time : 0.9                        20-Apr-2023 11:36:23
    number of iterations   : 6                         20-Apr-2023 11:36:23
    number of reformations : 6                         20-Apr-2023 11:36:23
------- converged at time : 0.933333                   20-Apr-2023 11:36:23
    number of iterations   : 6                         20-Apr-2023 11:36:24
    number of reformations : 6                         20-Apr-2023 11:36:24
------- converged at time : 0.966667                   20-Apr-2023 11:36:24
    number of iterations   : 5                         20-Apr-2023 11:36:25
    number of reformations : 5                         20-Apr-2023 11:36:25
------- converged at time : 1                          20-Apr-2023 11:36:25
 Elapsed time : 0:00:19                                20-Apr-2023 11:36:25
 N O R M A L   T E R M I N A T I O N
# Done                                                 20-Apr-2023 11:36:25
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
</pre><h2 id="22">Import FEBio results</h2><pre class="codeinput"><span class="keyword">if</span> runFlag==1 <span class="comment">%i.e. a succesful run</span>
</pre><p>Importing nodal displacements from a log file</p><pre class="codeinput">    dataStruct=importFEBio_logfile(fullfile(savePath,febioLogFileName_disp),0,1);

    <span class="comment">%Access data</span>
    N_disp_mat=dataStruct.data; <span class="comment">%Displacement</span>
    timeVec=dataStruct.time; <span class="comment">%Time</span>

    <span class="comment">%Create deformed coordinate set</span>
    V_DEF=N_disp_mat+repmat(V,[1 1 size(N_disp_mat,3)]);
</pre><p>Plotting the simulated results using <tt>anim8</tt> to visualize and animate deformations</p><pre class="codeinput">    DN_magnitude=sqrt(sum(N_disp_mat(:,:,end).^2,2)); <span class="comment">%Current displacement magnitude</span>

    <span class="comment">% Create basic view and store graphics handle to initiate animation</span>
    hf=cFigure; hold <span class="string">on</span>;
    gtitle([febioFebFileNamePart,<span class="string">': Press play to animate'</span>]);
    hp1=gpatch(Fb_blob,V_DEF(:,:,end),DN_magnitude,<span class="string">'k'</span>,1); <span class="comment">%Add graphics object to animate</span>
    hp1.FaceColor=<span class="string">'interp'</span>;
    hp2=gpatch(F_probe,V_DEF(:,:,end),<span class="string">'kw'</span>,<span class="string">'none'</span>,0.5); <span class="comment">%Add graphics object to animate</span>
    hp3=gpatch(F_plate,V_DEF(:,:,end),<span class="string">'kw'</span>,<span class="string">'none'</span>,0.5); <span class="comment">%Add graphics object to animate</span>

    axisGeom(gca,fontSize);
    colormap(gjet(250)); colorbar;
    caxis([0 max(DN_magnitude)]/3);
    axis(axisLim(V_DEF)); <span class="comment">%Set axis limits statically</span>
    camlight <span class="string">headlight</span>;
    drawnow;

    <span class="comment">% Set up animation features</span>
    animStruct.Time=timeVec; <span class="comment">%The time vector</span>
    <span class="keyword">for</span> qt=1:1:size(N_disp_mat,3) <span class="comment">%Loop over time increments</span>
        DN_magnitude=sqrt(sum(N_disp_mat(:,:,qt).^2,2)); <span class="comment">%Current displacement magnitue</span>

        <span class="comment">%Set entries in animation structure</span>
        animStruct.Handles{qt}=[hp1 hp1 hp2 hp3]; <span class="comment">%Handles of objects to animate</span>
        animStruct.Props{qt}={<span class="string">'Vertices'</span>,<span class="string">'CData'</span>,<span class="string">'Vertices'</span>,<span class="string">'Vertices'</span>}; <span class="comment">%Properties of objects to animate</span>
        animStruct.Set{qt}={V_DEF(:,:,qt),DN_magnitude,V_DEF(:,:,qt),V_DEF(:,:,qt)}; <span class="comment">%Property values for to set in order to animate</span>
    <span class="keyword">end</span>
    anim8(hf,animStruct); <span class="comment">%Initiate animation feature</span>
    drawnow;
</pre><img width="100%" height="auto" vspace="5" hspace="5" src="DEMO_febio_0031_blob_shear_contact_08.jpg" alt=""> <pre class="codeinput"><span class="keyword">end</span>
</pre><p><img vspace="5" hspace="5" src="gibbVerySmall.gif" alt=""> </p><p><i><b>GIBBON</b></i> <a href="www.gibboncode.org">www.gibboncode.org</a></p><p><i>Kevin Mattheus Moerman</i>, <a href="gibbon.toolbox@gmail.com">gibbon.toolbox@gmail.com</a></p><p><i><b>GIBBON footer text</b></i></p><p>License: <a href="https://github.com/gibbonCode/GIBBON/blob/master/LICENSE">https://github.com/gibbonCode/GIBBON/blob/master/LICENSE</a></p><p>GIBBON: The Geometry and Image-based Bioengineering add-On. A toolbox for image segmentation, image-based modeling, meshing, and finite element analysis.</p><p>Copyright (C) 2006-2022 Kevin Mattheus Moerman and the GIBBON contributors</p><p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p><p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.</p><p>You should have received a copy of the GNU General Public License along with this program.  If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.</p><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2022b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% DEMO_febio_0031_blob_shear_contact
% Below is a demonstration for:
% 
% * Building geometry for a hemi-spherical blob with tetrahedral elements
% which is being sheared by a rigid wall. 
% This demo consists off:
% * Defining the boundary conditions 
% * Coding the febio structure
% * Running the model
% * Importing and visualizing the displacement results

%% Keywords
%
% * febio_spec version 4.0
% * febio, FEBio
% * indentation
% * contact, sliding, sticky, friction
% * rigid body constraints
% * tetrahedral elements, tet4
% * triangular elements, tri3
% * slab, block, rectangular
% * sphere
% * static, solid
% * hyperelastic, Ogden
% * displacement logfile
% * stress logfile

%%

clear; close all; clc;

%% Plot settings
fontSize=15;
faceAlpha1=0.8;
faceAlpha2=0.3;
markerSize=40;
lineWidth=3;

%% Control parameters

% Path names
defaultFolder = fileparts(fileparts(mfilename('fullpath')));
savePath=fullfile(defaultFolder,'data','temp');

% Defining file names
febioFebFileNamePart='tempModel';
febioFebFileName=fullfile(savePath,[febioFebFileNamePart,'.feb']); %FEB file name
febioLogFileName=[febioFebFileNamePart,'.txt']; %FEBio log file name
febioLogFileName_disp=[febioFebFileNamePart,'_disp_out.txt']; %Log file name for exporting displacement
% febioLogFileName_force=[febioFebFileNamePart,'_force_out.txt']; %Log file name for exporting force

% Hemi-sphere parameters
hemiSphereRadius=1; 
nRefine=2; 
closeOption=1; 
smoothEdge=1; 

% Ground plate parameters
plateRadius=2*hemiSphereRadius; 

% Probe parameters
probeWidth=3*hemiSphereRadius; 
filletProbe=0.25; %Fillet radius

% Define probe displacement
probeDisplacement=hemiSphereRadius*2; 
probeOverlapFactor=0.4;

% Material parameter set
c1=1e-3; %Shear-modulus-like parameter
m1=2; %Material parameter setting degree of non-linearity
k_factor=10; %Bulk modulus factor 
k=c1*k_factor; %Bulk modulus

% FEA control settings
numTimeSteps=30;
max_refs=25; %Max reforms
max_ups=0; %Set to zero to use full-Newton iterations
opt_iter=10; %Optimum number of iterations
max_retries=25; %Maximum number of retires
symmetric_stiffness=0;
min_residual=1e-20;
step_size=1/numTimeSteps;
dtmin=(1/numTimeSteps)/100; %Minimum time step size
dtmax=(1/(numTimeSteps)); %Maximum time step size

runMode='external';% 'internal' or 'external'

%Contact parameters
contactPenalty=1;
laugon=0;
minaug=1;
maxaug=10;
fric_coeff=0.01; 
max_traction=0; 

%% Creating model geometry and mesh
% 

% Create hemi-sphere mesh
[F_blob,V_blob,C_blob]=hemiSphereMesh(nRefine,hemiSphereRadius,1);
pointSpacingBlob=mean(patchEdgeLengths(F_blob,V_blob));

%Smoothen edges
if smoothEdge==1
    %Get rigid region
    ind=1:1:size(V_blob,1); %Indices for all nodes
    indRigid=find(ismember(ind,F_blob(C_blob==2,:)) & ~ismember(ind,F_blob(C_blob==1,:))); %Indices for new bottom surface nodes
    
    %Smoothing
    cPar.Method='HC';
    cPar.n=250;
    cPar.RigidConstraints=indRigid;
    [V_blob]=patchSmooth(F_blob,V_blob,[],cPar);
    
    %Fix color data with new bottom surface
    C_blob=ones(size(C_blob));
    C_blob(all(ismember(F_blob,indRigid),2))=2;

end

%%
% Visualize hemi-sphere surface

cFigure; hold on;
gtitle('The hemi-sphere surface mesh',fontSize);
gpatch(F_blob,V_blob,C_blob,'k',0.85);
patchNormPlot(F_blob,V_blob);
axisGeom(gca,fontSize);
colormap(gjet); icolorbar;
camlight headlight; 
drawnow; 

%% 
% Using tetgen to create a tetrahedral mesh

% Tetgen input structure
inputStruct.stringOpt='-pq1.2AaY';
inputStruct.Faces=F_blob;
inputStruct.Nodes=V_blob;
inputStruct.holePoints=[];
inputStruct.faceBoundaryMarker=C_blob; %Face boundary markers
inputStruct.regionPoints=getInnerPoint(F_blob,V_blob); %region points
inputStruct.regionA=tetVolMeanEst(F_blob,V_blob);
inputStruct.minRegionMarker=2; %Minimum region marker
 
% Create tetrahedral mesh using tetGen 
[meshOutput]=runTetGen(inputStruct); %Run tetGen 
 
% Access model element and patch data
Fb_blob=fliplr(meshOutput.facesBoundary);
Cb_blob=meshOutput.boundaryMarker;
V_blob=meshOutput.nodes;
E_blob=meshOutput.elements;

%%
% Visualize blob mesh

hFig=cFigure; 
subplot(1,2,1); hold on;
gpatch(Fb_blob,V_blob,Cb_blob,'k',1);
patchNormPlot(Fb_blob,V_blob);
axisGeom(gca,fontSize);
colormap(gjet); icolorbar;
camlight headlight; 

hs=subplot(1,2,2); hold on; 
title('Cut view of solid mesh','FontSize',fontSize);
optionStruct.hFig=[hFig hs];
gpatch(Fb_blob,V_blob,'kw','none',0.25);
meshView(meshOutput,optionStruct);
axisGeom(gca,fontSize);
drawnow; 

%% Creating rigid body ground plate
% 

%Get outer surve of ground surface 
[Eb]=patchBoundary(Fb_blob(Cb_blob==2,:));
indCurveBottom=edgeListToCurve(Eb);
indCurveBottom=indCurveBottom(1:end-1);

% Derive point spacing for plate
pointSpacingPlate=pointSpacingBlob; 

% Compose outer curve of the plate
nPlateCurve=ceil((2*pi*plateRadius)/pointSpacingPlate);
t=linspace(0,2*pi,nPlateCurve);
t=t(1:end-1); 
x=plateRadius.*sin(t);
y=plateRadius.*cos(t); 
Vp_outer_curve=[x(:) y(:)];

% Copy inner curve from the hemi-sphere
Vp_inner_curve=V_blob(indCurveBottom,[1 2]);

% Create mesh out outer region
regionCell={Vp_outer_curve,Vp_inner_curve};
[F_plate,V_plate]=regionTriMesh2D(regionCell,pointSpacingPlate,0,0);
V_plate(:,3)=0; %Add z-direction

% Copy mesh for inner region
[F_plate_inner,V_plate_inner]=patchCleanUnused(fliplr(Fb_blob(Cb_blob==2,:)),V_blob);
[F_plate,V_plate,C_plate]=joinElementSets({F_plate,F_plate_inner},{V_plate,V_plate_inner});
[F_plate,V_plate]=mergeVertices(F_plate,V_plate);

center_of_mass_plate=mean(V_plate,1);

%%
% Visualizing plate mesh

cFigure; hold on;
gtitle('The plate surface mesh',fontSize);
gpatch(Fb_blob,V_blob,'kw','none',0.5);
gpatch(F_plate,V_plate,C_plate,'k',1);
patchNormPlot(F_plate,V_plate);
axisGeom(gca,fontSize);
colormap(gjet); icolorbar;
camlight headlight; 
drawnow; 

%% Creating rigid body shear surface

pointSpacingProbe=pointSpacingBlob/2; 

%Sketching side profile
x=[-hemiSphereRadius hemiSphereRadius hemiSphereRadius]-hemiSphereRadius*2;
y=[0 0 0];
z=[hemiSphereRadius*(1-probeOverlapFactor) hemiSphereRadius*(1-probeOverlapFactor) hemiSphereRadius*1.5];
V_probe_curve_sketch=[x(:) y(:) z(:)];

%Fillet sketch
np=100; %Number of points used to construct each fillet edge
[V_probe_curve]=filletCurve(V_probe_curve_sketch,filletProbe,np,0);
numPointsProbeCurve=ceil(max(pathLength(V_probe_curve))/pointSpacingProbe);
[V_probe_curve] = evenlySampleCurve(V_probe_curve,numPointsProbeCurve,'pchip',0);

% Extruding curve
% controlParametersExtrude.pointSpacing=pointSpacingProbe;
controlParametersExtrude.depth=hemiSphereRadius*2.5; 
controlParametersExtrude.numSteps=ceil(controlParametersExtrude.depth/pointSpacingProbe);
controlParametersExtrude.numSteps=controlParametersExtrude.numSteps+iseven(controlParametersExtrude.numSteps); %Force uneven
controlParametersExtrude.patchType='tri'; 
controlParametersExtrude.dir=0;
controlParametersExtrude.n=[0 1 0];
controlParametersExtrude.closeLoopOpt=0; 

[F_probe,V_probe]=polyExtrude(V_probe_curve,controlParametersExtrude);
F_probe=fliplr(F_probe); %Invert face orientation so normals point to blob

center_of_mass_probe=mean(V_probe,1);

%%
% Visualizing probe mesh

cFigure; hold on;
title('The probe surface mesh','fontSize',fontSize);
gpatch(Fb_blob,V_blob,'kw','none',0.5);
gpatch(F_plate,V_plate,'kw','none',0.5);
hl(1)=plotV(V_probe_curve_sketch,'k.-.','lineWidth',3,'MarkerSize',25);
hl(2)=plotV(V_probe_curve,'r-','lineWidth',3,'MarkerSize',25);
hl(3)=gpatch(F_probe,V_probe,'gw','k',1);
legend(hl,{'Sketched probe curve','Rounded probe curve','Probe surface mesh'}); clear hl;
axisGeom(gca,fontSize);
camlight headlight; 
drawnow; 

%% Join model node sets

V=[V_blob; V_plate; V_probe];
F_plate=F_plate+size(V_blob,1);
F_probe=F_probe+size(V_blob,1)+size(V_plate,1);
Fb_all=[Fb_blob;F_plate;F_probe];

%%
% Visualizing model

cFigure; hold on;
gtitle('Model components',fontSize);
hl(1)=gpatch(Fb_blob,V,'rw','k',0.8);
hl(2)=gpatch(F_plate,V,'bw','k',0.8);
hl(3)=gpatch(F_probe,V,'gw','k',0.8);
legend(hl,{'Blob','Plate','Probe'}); clear hl;
axisGeom(gca,fontSize);
camlight headlight; 
drawnow; 

%% Get contact surfaces
%

% F_contact_blob1=Fb_blob(Cb_blob==1,:);
% F_contact_blob2=Fb_blob(Cb_blob==2,:);

%%
% Visualize contact surfaces

cFigure; 
subplot(1,2,1); hold on;
title('Probe blob contact pair','fontsize',fontSize);
hl(1)=gpatch(F_probe,V,'rw','k',1);
patchNormPlot(F_probe,V);
hl(2)=gpatch(Fb_blob,V,'gw','k',1);
patchNormPlot(Fb_blob,V);
legend(hl,{'secondary','primary'}); clear hl;
axisGeom(gca,fontSize);
camlight headlight; 

subplot(1,2,2); hold on;
title('Plate blob contact pair','fontsize',fontSize);
hl(1)=gpatch(F_plate,V,'rw','k',1);
patchNormPlot(F_plate,V);
hl(2)=gpatch(Fb_blob,V,'gw','k',1);
patchNormPlot(Fb_blob,V);
legend(hl,{'secondary','primary'}); clear hl;
axisGeom(gca,fontSize);
camlight headlight; 

drawnow; 

%% Defining the FEBio input structure
% See also |febioStructTemplate| and |febioStruct2xml| and the FEBio user
% manual.

%Get a template with default settings 
[febio_spec]=febioStructTemplate;

%febio_spec version 
febio_spec.ATTR.version='4.0'; 

%Module section
febio_spec.Module.ATTR.type='solid'; 

%Control section
febio_spec.Control.analysis='STATIC';
febio_spec.Control.time_steps=numTimeSteps;
febio_spec.Control.step_size=1/numTimeSteps;
febio_spec.Control.solver.max_refs=max_refs;
febio_spec.Control.solver.qn_method.max_ups=max_ups;
febio_spec.Control.solver.symmetric_stiffness=symmetric_stiffness;
febio_spec.Control.time_stepper.dtmin=dtmin;
febio_spec.Control.time_stepper.dtmax=dtmax; 
febio_spec.Control.time_stepper.max_retries=max_retries;
febio_spec.Control.time_stepper.opt_iter=opt_iter;

%Material section
materialName1='Material1';
febio_spec.Material.material{1}.ATTR.name=materialName1;
febio_spec.Material.material{1}.ATTR.type='Ogden';
febio_spec.Material.material{1}.ATTR.id=1;
febio_spec.Material.material{1}.c1=c1;
febio_spec.Material.material{1}.m1=m1;
febio_spec.Material.material{1}.c2=c1;
febio_spec.Material.material{1}.m2=-m1;
febio_spec.Material.material{1}.k=k;

materialName2='Material2';
febio_spec.Material.material{2}.ATTR.name=materialName2;
febio_spec.Material.material{2}.ATTR.type='rigid body';
febio_spec.Material.material{2}.ATTR.id=2;
febio_spec.Material.material{2}.density=1;
febio_spec.Material.material{2}.center_of_mass=center_of_mass_plate;

materialName3='Material3';
febio_spec.Material.material{3}.ATTR.name=materialName3;
febio_spec.Material.material{3}.ATTR.type='rigid body';
febio_spec.Material.material{3}.ATTR.id=3;
febio_spec.Material.material{3}.density=1;
febio_spec.Material.material{3}.center_of_mass=center_of_mass_probe;

%Mesh section
% -> Nodes
febio_spec.Mesh.Nodes{1}.ATTR.name='nodeSet_all'; %The node set name
febio_spec.Mesh.Nodes{1}.node.ATTR.id=(1:size(V,1))'; %The node id's
febio_spec.Mesh.Nodes{1}.node.VAL=V; %The nodel coordinates

% -> Elements
partName1='Part1';
febio_spec.Mesh.Elements{1}.ATTR.name=partName1; %Name of this part
febio_spec.Mesh.Elements{1}.ATTR.type='tet4'; %Element type 
febio_spec.Mesh.Elements{1}.elem.ATTR.id=(1:1:size(E_blob,1))'; %Element id's
febio_spec.Mesh.Elements{1}.elem.VAL=E_blob; %The element matrix

partName2='Part2';
febio_spec.Mesh.Elements{2}.ATTR.name=partName2; %Name of this part
febio_spec.Mesh.Elements{2}.ATTR.type='tri3'; %Element type 
febio_spec.Mesh.Elements{2}.elem.ATTR.id=size(E_blob,1)+(1:1:size(F_plate,1))'; %Element id's
febio_spec.Mesh.Elements{2}.elem.VAL=F_plate;

partName3='Part3';
febio_spec.Mesh.Elements{3}.ATTR.name=partName3; %Name of this part
febio_spec.Mesh.Elements{3}.ATTR.type='tri3'; %Element type 
febio_spec.Mesh.Elements{3}.elem.ATTR.id=size(E_blob,1)+size(F_plate,1)+(1:1:size(F_probe,1))'; %Element id's
febio_spec.Mesh.Elements{3}.elem.VAL=F_probe;

%MeshDomains section
febio_spec.MeshDomains.SolidDomain{1}.ATTR.name=partName1;
febio_spec.MeshDomains.SolidDomain{1}.ATTR.mat=materialName1;

febio_spec.MeshDomains.ShellDomain{1}.ATTR.name=partName2;
febio_spec.MeshDomains.ShellDomain{1}.ATTR.mat=materialName2;

febio_spec.MeshDomains.ShellDomain{2}.ATTR.name=partName3;
febio_spec.MeshDomains.ShellDomain{2}.ATTR.mat=materialName3;

% % -> Surfaces
surfaceName1='contactSurface1';
febio_spec.Mesh.Surface{1}.ATTR.name=surfaceName1;
febio_spec.Mesh.Surface{1}.tri3.ATTR.id=(1:1:size(F_plate,1))';
febio_spec.Mesh.Surface{1}.tri3.VAL=F_plate;

surfaceName2='contactSurface2';
febio_spec.Mesh.Surface{2}.ATTR.name=surfaceName2;
febio_spec.Mesh.Surface{2}.tri3.ATTR.id=(1:1:size(Fb_blob,1))';
febio_spec.Mesh.Surface{2}.tri3.VAL=Fb_blob;

surfaceName3='contactSurface3';
febio_spec.Mesh.Surface{3}.ATTR.name=surfaceName3;
febio_spec.Mesh.Surface{3}.tri3.ATTR.id=(1:1:size(F_probe,1))';
febio_spec.Mesh.Surface{3}.tri3.VAL=F_probe;

surfaceName4='contactSurface4';
febio_spec.Mesh.Surface{4}.ATTR.name=surfaceName4;
febio_spec.Mesh.Surface{4}.tri3.ATTR.id=(1:1:size(Fb_blob(Cb_blob==1,:),1))';
febio_spec.Mesh.Surface{4}.tri3.VAL=Fb_blob(Cb_blob==1,:);

% -> Surface pairs
contactPairName1='Contact1';
febio_spec.Mesh.SurfacePair{1}.ATTR.name=contactPairName1;
febio_spec.Mesh.SurfacePair{1}.primary=surfaceName2;
febio_spec.Mesh.SurfacePair{1}.secondary=surfaceName1;

contactPairName2='Contact2';
febio_spec.Mesh.SurfacePair{2}.ATTR.name=contactPairName2;
febio_spec.Mesh.SurfacePair{2}.primary=surfaceName4;
febio_spec.Mesh.SurfacePair{2}.secondary=surfaceName3;

%Rigid section 
% ->Rigid body fix boundary conditions
febio_spec.Rigid.rigid_bc{1}.ATTR.name='RigidFix_1';
febio_spec.Rigid.rigid_bc{1}.ATTR.type='rigid_fixed';
febio_spec.Rigid.rigid_bc{1}.rb=2;
febio_spec.Rigid.rigid_bc{1}.Rx_dof=1;
febio_spec.Rigid.rigid_bc{1}.Ry_dof=1;
febio_spec.Rigid.rigid_bc{1}.Rz_dof=1;
febio_spec.Rigid.rigid_bc{1}.Ru_dof=1;
febio_spec.Rigid.rigid_bc{1}.Rv_dof=1;
febio_spec.Rigid.rigid_bc{1}.Rw_dof=1;

febio_spec.Rigid.rigid_bc{2}.ATTR.name='RigidFix_2';
febio_spec.Rigid.rigid_bc{2}.ATTR.type='rigid_fixed';
febio_spec.Rigid.rigid_bc{2}.rb=3;
% febio_spec.Rigid.rigid_bc{2}.Rx_dof=1;
febio_spec.Rigid.rigid_bc{2}.Ry_dof=1;
febio_spec.Rigid.rigid_bc{2}.Rz_dof=1;
febio_spec.Rigid.rigid_bc{2}.Ru_dof=1;
febio_spec.Rigid.rigid_bc{2}.Rv_dof=1;
febio_spec.Rigid.rigid_bc{2}.Rw_dof=1;

% ->Rigid body prescribe boundary conditions
febio_spec.Rigid.rigid_bc{3}.ATTR.name='RigidPrescribe';
febio_spec.Rigid.rigid_bc{3}.ATTR.type='rigid_displacement';
febio_spec.Rigid.rigid_bc{3}.rb=3;
febio_spec.Rigid.rigid_bc{3}.dof='x';
febio_spec.Rigid.rigid_bc{3}.value.ATTR.lc=1;
febio_spec.Rigid.rigid_bc{3}.value.VAL=probeDisplacement;
febio_spec.Rigid.rigid_bc{3}.relative=0;

%Contact section
% -> Contact 1
febio_spec.Contact.contact{1}.ATTR.type='sticky';
febio_spec.Contact.contact{1}.ATTR.surface_pair=contactPairName1;
febio_spec.Contact.contact{1}.penalty=10;
febio_spec.Contact.contact{1}.laugon=0;
febio_spec.Contact.contact{1}.tolerance=0.1;
febio_spec.Contact.contact{1}.minaug=1;
febio_spec.Contact.contact{1}.maxaug=10;
febio_spec.Contact.contact{1}.snap_tol=0;
febio_spec.Contact.contact{1}.max_traction=max_traction;
febio_spec.Contact.contact{1}.search_tolerance=0.1;

febio_spec.Contact.contact{2}.ATTR.type='sliding-elastic';
febio_spec.Contact.contact{2}.ATTR.surface_pair=contactPairName2;
febio_spec.Contact.contact{2}.two_pass=0;
febio_spec.Contact.contact{2}.laugon=laugon;
febio_spec.Contact.contact{2}.tolerance=0.2;
febio_spec.Contact.contact{2}.gaptol=0;
febio_spec.Contact.contact{2}.minaug=minaug;
febio_spec.Contact.contact{2}.maxaug=maxaug;
febio_spec.Contact.contact{2}.search_tol=0.01;
febio_spec.Contact.contact{2}.search_radius=0.1*sqrt(sum((max(V,[],1)-min(V,[],1)).^2,2)); 
febio_spec.Contact.contact{2}.symmetric_stiffness=0;
febio_spec.Contact.contact{2}.auto_penalty=1;
febio_spec.Contact.contact{2}.penalty=contactPenalty;
febio_spec.Contact.contact{2}.fric_coeff=fric_coeff;

%LoadData section
% -> load_controller
febio_spec.LoadData.load_controller{1}.ATTR.name='LC_1';
febio_spec.LoadData.load_controller{1}.ATTR.id=1;
febio_spec.LoadData.load_controller{1}.ATTR.type='loadcurve';
febio_spec.LoadData.load_controller{1}.interpolate='LINEAR';
%febio_spec.LoadData.load_controller{1}.extend='CONSTANT';
febio_spec.LoadData.load_controller{1}.points.pt.VAL=[0 0; 1 1];

%Output section 
% -> log file
febio_spec.Output.logfile.ATTR.file=febioLogFileName;
febio_spec.Output.logfile.node_data{1}.ATTR.file=febioLogFileName_disp;
febio_spec.Output.logfile.node_data{1}.ATTR.data='ux;uy;uz';
febio_spec.Output.logfile.node_data{1}.ATTR.delim=',';

%% Quick viewing of the FEBio input file structure
% The |febView| function can be used to view the xml structure in a MATLAB
% figure window. 

%%
% |febView(febio_spec); %Viewing the febio file|

%% Exporting the FEBio input file
% Exporting the febio_spec structure to an FEBio input file is done using
% the |febioStruct2xml| function. 

febioStruct2xml(febio_spec,febioFebFileName); %Exporting to file and domNode

%% Running the FEBio analysis
% To run the analysis defined by the created FEBio input file the
% |runMonitorFEBio| function is used. The input for this function is a
% structure defining job settings e.g. the FEBio input file name. The
% optional output runFlag informs the user if the analysis was run
% succesfully. 

febioAnalysis.run_filename=febioFebFileName; %The input file name
febioAnalysis.run_logname=febioLogFileName; %The name for the log file
febioAnalysis.disp_on=1; %Display information on the command window
febioAnalysis.runMode='external';%'internal';

[runFlag]=runMonitorFEBio(febioAnalysis);%START FEBio NOW!!!!!!!!

%% Import FEBio results 

if runFlag==1 %i.e. a succesful run
    
    %% 
    % Importing nodal displacements from a log file
    dataStruct=importFEBio_logfile(fullfile(savePath,febioLogFileName_disp),0,1);
    
    %Access data
    N_disp_mat=dataStruct.data; %Displacement
    timeVec=dataStruct.time; %Time
    
    %Create deformed coordinate set
    V_DEF=N_disp_mat+repmat(V,[1 1 size(N_disp_mat,3)]);
    
    %%  
    % Plotting the simulated results using |anim8| to visualize and animate
    % deformations 
    
    DN_magnitude=sqrt(sum(N_disp_mat(:,:,end).^2,2)); %Current displacement magnitude
        
    % Create basic view and store graphics handle to initiate animation
    hf=cFigure; hold on;
    gtitle([febioFebFileNamePart,': Press play to animate']);
    hp1=gpatch(Fb_blob,V_DEF(:,:,end),DN_magnitude,'k',1); %Add graphics object to animate
    hp1.FaceColor='interp';
    hp2=gpatch(F_probe,V_DEF(:,:,end),'kw','none',0.5); %Add graphics object to animate
    hp3=gpatch(F_plate,V_DEF(:,:,end),'kw','none',0.5); %Add graphics object to animate
    
    axisGeom(gca,fontSize); 
    colormap(gjet(250)); colorbar;
    caxis([0 max(DN_magnitude)]/3);
    axis(axisLim(V_DEF)); %Set axis limits statically  
    camlight headlight;
    drawnow; 
    
    % Set up animation features
    animStruct.Time=timeVec; %The time vector
    for qt=1:1:size(N_disp_mat,3) %Loop over time increments
        DN_magnitude=sqrt(sum(N_disp_mat(:,:,qt).^2,2)); %Current displacement magnitue
        
        %Set entries in animation structure
        animStruct.Handles{qt}=[hp1 hp1 hp2 hp3]; %Handles of objects to animate
        animStruct.Props{qt}={'Vertices','CData','Vertices','Vertices'}; %Properties of objects to animate
        animStruct.Set{qt}={V_DEF(:,:,qt),DN_magnitude,V_DEF(:,:,qt),V_DEF(:,:,qt)}; %Property values for to set in order to animate
    end
    anim8(hf,animStruct); %Initiate animation feature
    drawnow;

end

%% 
%
% <<gibbVerySmall.gif>>
% 
% _*GIBBON*_ 
% <www.gibboncode.org>
% 
% _Kevin Mattheus Moerman_, <gibbon.toolbox@gmail.com>
 
%% 
% _*GIBBON footer text*_ 
% 
% License: <https://github.com/gibbonCode/GIBBON/blob/master/LICENSE>
% 
% GIBBON: The Geometry and Image-based Bioengineering add-On. A toolbox for
% image segmentation, image-based modeling, meshing, and finite element
% analysis.
% 
% Copyright (C) 2006-2022 Kevin Mattheus Moerman and the GIBBON contributors
% 
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.

##### SOURCE END #####
--></body></html>
