
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>DEMO_abaqus_0001_cube_uniaxial</title><meta name="generator" content="MATLAB 9.13"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2023-04-20"><meta name="DC.source" content="DEMO_abaqus_0001_cube_uniaxial.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>DEMO_abaqus_0001_cube_uniaxial</h1><!--introduction--><p>Below is a demonstration for:</p><div><ul><li>Building geometry for a cube with hexahedral elements</li><li>Defining the boundary conditions</li><li>Coding the abaqus structure</li><li>Running the model</li><li>Importing and visualizing the displacement and stress results</li></ul></div><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Keywords</a></li><li><a href="#3">Plot settings</a></li><li><a href="#4">Control parameters</a></li><li><a href="#5">Creating model geometry and mesh</a></li><li><a href="#7">Defining the boundary conditions</a></li><li><a href="#9">Defining the abaqus input structure</a></li><li><a href="#11">Run the job using Abaqus</a></li><li><a href="#13">Import and visualize abaqus results</a></li><li><a href="#14">Get element data</a></li></ul></div><h2 id="1">Keywords</h2><div><ul><li>abaqus</li><li>uniaxial loading</li><li>compression, tension, compressive, tensile</li><li>displacement control, displacement boundary condition</li><li>hexahedral elements, hex8</li><li>cube, box, rectangular</li><li>static, solid</li><li>hyperelastic, Ogden</li><li>displacement logfile</li><li>stress logfile</li></ul></div><pre class="codeinput">clear; close <span class="string">all</span>; clc;
</pre><h2 id="3">Plot settings</h2><pre class="codeinput">fontSize=20;
faceAlpha1=0.8;
markerSize=40;
lineWidth=3;
</pre><h2 id="4">Control parameters</h2><pre class="codeinput"><span class="comment">% Path names</span>
defaultFolder = fileparts(fileparts(mfilename(<span class="string">'fullpath'</span>)));
savePath=fullfile(defaultFolder,<span class="string">'data'</span>,<span class="string">'temp'</span>);

<span class="comment">% Defining file names</span>
abaqusInpFileNamePart=<span class="string">'tempModel'</span>;
abaqusInpFileName=fullfile(savePath,[abaqusInpFileNamePart,<span class="string">'.inp'</span>]); <span class="comment">%INP file name</span>
abaqusDATFileName=fullfile(savePath,[abaqusInpFileNamePart,<span class="string">'.dat'</span>]); <span class="comment">%DAT file name</span>

<span class="comment">%Specifying dimensions and number of elements</span>
cubeSize=10;
sampleWidth=cubeSize; <span class="comment">%Width</span>
sampleThickness=cubeSize; <span class="comment">%Thickness</span>
sampleHeight=cubeSize; <span class="comment">%Height</span>
pointSpacings=2*ones(1,3); <span class="comment">%Desired point spacing between nodes</span>
numElementsWidth=round(sampleWidth/pointSpacings(1)); <span class="comment">%Number of elemens in dir 1</span>
numElementsThickness=round(sampleThickness/pointSpacings(2)); <span class="comment">%Number of elemens in dir 2</span>
numElementsHeight=round(sampleHeight/pointSpacings(3)); <span class="comment">%Number of elemens in dir 3</span>

<span class="comment">%Define applied displacement</span>
appliedStrain=0.3; <span class="comment">%Linear strain (Only used to compute applied stretch)</span>
loadingOption=<span class="string">'compression'</span>; <span class="comment">% or 'tension'</span>
<span class="keyword">switch</span> loadingOption
    <span class="keyword">case</span> <span class="string">'compression'</span>
        stretchLoad=1-appliedStrain; <span class="comment">%The applied stretch for uniaxial loading</span>
    <span class="keyword">case</span> <span class="string">'tension'</span>
        stretchLoad=1+appliedStrain; <span class="comment">%The applied stretch for uniaxial loading</span>
<span class="keyword">end</span>
displacementMagnitude=(stretchLoad*sampleHeight)-sampleHeight; <span class="comment">%The displacement magnitude</span>

<span class="comment">%Material parameter set</span>
E_youngs=1e-3;
v_poisson=0.4;
</pre><h2 id="5">Creating model geometry and mesh</h2><p>A box is created with tri-linear hexahedral (hex8) elements using the <tt>hexMeshBox</tt> function. The function offers the boundary faces with seperate labels for the top, bottom, left, right, front, and back sides. As such these can be used to define boundary conditions on the exterior.</p><pre class="codeinput"><span class="comment">% Create a box with hexahedral elements</span>
cubeDimensions=[sampleWidth sampleThickness sampleHeight]; <span class="comment">%Dimensions</span>
cubeElementNumbers=[numElementsWidth numElementsThickness numElementsHeight]; <span class="comment">%Number of elements</span>
outputStructType=2; <span class="comment">%A structure compatible with mesh view</span>
[meshStruct]=hexMeshBox(cubeDimensions,cubeElementNumbers,outputStructType);

<span class="comment">%Access elements, nodes, and faces from the structure</span>
E=meshStruct.elements; <span class="comment">%The elements</span>
V=meshStruct.nodes; <span class="comment">%The nodes (vertices)</span>
Fb=meshStruct.facesBoundary; <span class="comment">%The boundary faces</span>
Cb=meshStruct.boundaryMarker; <span class="comment">%The "colors" or labels for the boundary faces</span>
elementMaterialIndices=ones(size(E,1),1); <span class="comment">%Element material indices</span>
</pre><p>Plotting model boundary surfaces and a cut view</p><pre class="codeinput">hFig=cFigure;

subplot(1,2,1); hold <span class="string">on</span>;
title(<span class="string">'Model boundary surfaces and labels'</span>,<span class="string">'FontSize'</span>,fontSize);
gpatch(Fb,V,Cb,<span class="string">'k'</span>,faceAlpha1);
colormap(gjet(6)); icolorbar;
axisGeom(gca,fontSize);

hs=subplot(1,2,2); hold <span class="string">on</span>;
title(<span class="string">'Cut view of solid mesh'</span>,<span class="string">'FontSize'</span>,fontSize);
optionStruct.hFig=[hFig hs];
meshView(meshStruct,optionStruct);
axisGeom(gca,fontSize);

drawnow;
</pre><img width="100%" height="auto" vspace="5" hspace="5" src="DEMO_abaqus_0001_cube_uniaxial_01.jpg" alt=""> <h2 id="7">Defining the boundary conditions</h2><p>The visualization of the model boundary shows colors for each side of the cube. These labels can be used to define boundary conditions.</p><pre class="codeinput"><span class="comment">%Define supported node sets</span>
logicFace=Cb==1; <span class="comment">%Logic for current face set</span>
Fr=Fb(logicFace,:); <span class="comment">%The current face set</span>
bcSupportList_X=unique(Fr(:)); <span class="comment">%Node set part of selected face</span>

logicFace=Cb==3; <span class="comment">%Logic for current face set</span>
Fr=Fb(logicFace,:); <span class="comment">%The current face set</span>
bcSupportList_Y=unique(Fr(:)); <span class="comment">%Node set part of selected face</span>

logicFace=Cb==5; <span class="comment">%Logic for current face set</span>
Fr=Fb(logicFace,:); <span class="comment">%The current face set</span>
bcSupportList_Z=unique(Fr(:)); <span class="comment">%Node set part of selected face</span>

<span class="comment">%Prescribed displacement nodes</span>
logicPrescribe=Cb==6; <span class="comment">%Logic for current face set</span>
Fr=Fb(logicPrescribe,:); <span class="comment">%The current face set</span>
bcPrescribeList=unique(Fr(:)); <span class="comment">%Node set part of selected face</span>
</pre><p>Visualizing boundary conditions. Markers plotted on the semi-transparent model denote the nodes in the various boundary condition lists.</p><pre class="codeinput">hf=cFigure;
title(<span class="string">'Boundary conditions'</span>,<span class="string">'FontSize'</span>,fontSize);
xlabel(<span class="string">'X'</span>,<span class="string">'FontSize'</span>,fontSize); ylabel(<span class="string">'Y'</span>,<span class="string">'FontSize'</span>,fontSize); zlabel(<span class="string">'Z'</span>,<span class="string">'FontSize'</span>,fontSize);
hold <span class="string">on</span>;

gpatch(Fb,V,<span class="string">'kw'</span>,<span class="string">'k'</span>,0.5);

hl(1)=plotV(V(bcSupportList_X,:),<span class="string">'r.'</span>,<span class="string">'MarkerSize'</span>,markerSize);
hl(2)=plotV(V(bcSupportList_Y,:),<span class="string">'g+'</span>,<span class="string">'MarkerSize'</span>,markerSize*2);
hl(3)=plotV(V(bcSupportList_Z,:),<span class="string">'b*'</span>,<span class="string">'MarkerSize'</span>,markerSize);
hl(4)=plotV(V(bcPrescribeList,:),<span class="string">'ko'</span>,<span class="string">'MarkerSize'</span>,markerSize);

legend(hl,{<span class="string">'BC x support'</span>,<span class="string">'BC y support'</span>,<span class="string">'BC z support'</span>,<span class="string">'BC z prescribe'</span>});

axisGeom(gca,fontSize);
camlight <span class="string">headlight</span>;
drawnow;
</pre><img width="100%" height="auto" vspace="5" hspace="5" src="DEMO_abaqus_0001_cube_uniaxial_02.jpg" alt=""> <h2 id="9">Defining the abaqus input structure</h2><p>See also <tt>abaqusStructTemplate</tt> and <tt>abaqusStruct2inp</tt> and the abaqus user manual.</p><pre class="codeinput"><span class="comment">%%--&gt; Heading</span>
abaqus_spec.Heading.COMMENT{1}=<span class="string">'Job name: ABAQUS inp file creation demo'</span>;
abaqus_spec.Heading.COMMENT{2}=<span class="string">'Generated by: GIBBON'</span>;

<span class="comment">%%--&gt; Preprint</span>
abaqus_spec.Preprint.ATTR.echo=<span class="string">'NO'</span>;
abaqus_spec.Preprint.ATTR.model=<span class="string">'NO'</span>;
abaqus_spec.Preprint.ATTR.history=<span class="string">'NO'</span>;
abaqus_spec.Preprint.ATTR.contact=<span class="string">'NO'</span>;

<span class="comment">%--&gt; Part</span>

<span class="comment">% Node</span>
nodeIds=(1:1:size(V,1))';
abaqus_spec.Part.COMMENT=<span class="string">'This section defines the part geometry in terms of nodes and elements'</span>;
abaqus_spec.Part.ATTR.name=<span class="string">'Cube'</span>;
abaqus_spec.Part.Node={nodeIds,V};

<span class="comment">% Element</span>
elementIds=(1:1:size(E,1));
abaqus_spec.Part.Element{1}.ATTR.type=<span class="string">'C3D8'</span>;<span class="comment">%'C3D8R';</span>
abaqus_spec.Part.Element{1}.VAL={elementIds(:),E};

<span class="comment">% Element sets</span>
abaqus_spec.Part.Elset{1}.ATTR.elset=<span class="string">'Set-1'</span>;
abaqus_spec.Part.Elset{1}.VAL=elementIds;

<span class="comment">% Sections</span>
abaqus_spec.Part.Solid_section.ATTR.elset=<span class="string">'Set-1'</span>;
abaqus_spec.Part.Solid_section.ATTR.material=<span class="string">'Elastic'</span>;

<span class="comment">%%--&gt; Assembly</span>
abaqus_spec.Assembly.ATTR.name=<span class="string">'Assembly-1'</span>;
abaqus_spec.Assembly.Instance.ATTR.name=<span class="string">'Cube-assembly'</span>;
abaqus_spec.Assembly.Instance.ATTR.part=<span class="string">'Cube'</span>;

abaqus_spec.Assembly.Nset{1}.ATTR.nset=<span class="string">'Set-1'</span>;
abaqus_spec.Assembly.Nset{1}.ATTR.instance=<span class="string">'Cube-assembly'</span>;
abaqus_spec.Assembly.Nset{1}.VAL=bcSupportList_X(:)';

abaqus_spec.Assembly.Nset{2}.ATTR.nset=<span class="string">'Set-2'</span>;
abaqus_spec.Assembly.Nset{2}.ATTR.instance=<span class="string">'Cube-assembly'</span>;
abaqus_spec.Assembly.Nset{2}.VAL=bcSupportList_Y(:)';

abaqus_spec.Assembly.Nset{3}.ATTR.nset=<span class="string">'Set-3'</span>;
abaqus_spec.Assembly.Nset{3}.ATTR.instance=<span class="string">'Cube-assembly'</span>;
abaqus_spec.Assembly.Nset{3}.VAL=bcSupportList_Z(:)';

abaqus_spec.Assembly.Nset{4}.ATTR.nset=<span class="string">'Set-4'</span>;
abaqus_spec.Assembly.Nset{4}.ATTR.instance=<span class="string">'Cube-assembly'</span>;
abaqus_spec.Assembly.Nset{4}.VAL=bcPrescribeList(:)';

abaqus_spec.Assembly.Nset{5}.ATTR.nset=<span class="string">'all'</span>;
abaqus_spec.Assembly.Nset{5}.ATTR.instance=<span class="string">'Cube-assembly'</span>;
abaqus_spec.Assembly.Nset{5}.VAL=1:1:size(V,1);

<span class="comment">%%--&gt; Material</span>
abaqus_spec.Material.ATTR.name=<span class="string">'Elastic'</span>;
abaqus_spec.Material.Elastic=[E_youngs v_poisson];

<span class="comment">%%--&gt; Step</span>
abaqus_spec.Step.ATTR.name=<span class="string">'Step-1'</span>;
abaqus_spec.Step.ATTR.nlgeom=<span class="string">'YES'</span>;
abaqus_spec.Step.Static=[0.1 1 1e-5 0.1];

<span class="comment">% Boundary</span>
abaqus_spec.Step.Boundary{1}.VAL={<span class="string">'Set-1'</span>,[1,1]};
abaqus_spec.Step.Boundary{2}.VAL={<span class="string">'Set-2'</span>,[2,2]};
abaqus_spec.Step.Boundary{3}.VAL={<span class="string">'Set-3'</span>,[3,3]};
abaqus_spec.Step.Boundary{4}.VAL={<span class="string">'Set-4'</span>,[3,3],displacementMagnitude};

<span class="comment">%Output</span>
abaqus_spec.Step.Restart.ATTR.write=<span class="string">''</span>;
abaqus_spec.Step.Restart.ATTR.frequency=0;

abaqus_spec.Step.Output{1}.ATTR.field=<span class="string">''</span>;
abaqus_spec.Step.Output{1}.ATTR.variable=<span class="string">'PRESELECT'</span>;
abaqus_spec.Step.Output{2}.ATTR.history=<span class="string">''</span>;
abaqus_spec.Step.Output{2}.ATTR.variable=<span class="string">'PRESELECT'</span>;

<span class="comment">%Nodal coordinates</span>
abaqus_spec.Step.Node_print{1}.ATTR.nset=<span class="string">'all'</span>;
abaqus_spec.Step.Node_print{1}.ATTR.frequency = 1;
abaqus_spec.Step.Node_print{1}.VAL=<span class="string">'COORD'</span>;

abaqus_spec.Step.El_print{1}.VAL=<span class="string">'S'</span>;
abaqus_spec.Step.El_print{2}.VAL=<span class="string">'E'</span>;
</pre><pre class="codeinput">abaqusStruct2inp(abaqus_spec,abaqusInpFileName);

<span class="comment">%textView(abaqusInpFileName);</span>
</pre><h2 id="11">Run the job using Abaqus</h2><pre class="codeinput">lockFileName=fullfile(savePath,[abaqusInpFileNamePart,<span class="string">'.lck'</span>]);
<span class="keyword">if</span> exist(lockFileName,<span class="string">'file'</span>)
    warning(<span class="string">'Lockfile found and deleted'</span>)
    delete(lockFileName);
<span class="keyword">end</span>
</pre><pre class="codeinput">oldPath=pwd; <span class="comment">%Get current working directory</span>
cd(savePath); <span class="comment">%Set new working directory to match save patch</span>

abaqusPath=<span class="string">'abaqus'</span>;<span class="comment">%'/usr/bin/abaqus'; %Abaqus excute command or path</span>
runFlag=system([abaqusPath,<span class="string">' inp="'</span>,abaqusInpFileName,<span class="string">'" job='</span>,abaqusInpFileNamePart,<span class="string">' interactive ask_delete=OFF'</span>]);

cd(oldPath); <span class="comment">%Restore working directory</span>
</pre><pre class="codeoutput">/bin/bash: line 1: abaqus: command not found
</pre><h2 id="13">Import and visualize abaqus results</h2><p>Importing the abaqus .dat file</p><pre class="codeinput">[abaqusData]=importAbaqusDat(abaqusDATFileName);
</pre><pre class="codeoutput error">Error using textscan
Invalid file identifier. Use fopen to generate a valid file identifier.

Error in txtfile2cell (line 16)
T=textscan(fid,'%s','delimiter', '\n','Whitespace','');

Error in importAbaqusDat (line 61)
T=txtfile2cell(fileName);

Error in DEMO_abaqus_0001_cube_uniaxial (line 270)
[abaqusData]=importAbaqusDat(abaqusDATFileName);
</pre><h2 id="14">Get element data</h2><pre class="codeinput">E_effectiveStress=zeros(size(E,1),numel(abaqusData.STEP.INCREMENT)+1);
E_effectiveStrain=zeros(size(E,1),numel(abaqusData.STEP.INCREMENT)+1);
<span class="keyword">for</span> q=1:1:numel(abaqusData.STEP.INCREMENT)

    <span class="keyword">for</span> d=1:1:2
        dataSet=abaqusData.STEP.INCREMENT(q).elementOutput(d); <span class="comment">%Get data structure</span>
        <span class="keyword">switch</span> d
            <span class="keyword">case</span> 1
                <span class="comment">% Get element data across all 8 integration points</span>
                D11_PT=reshape(dataSet.data.S11,8,size(E,1))';
                D22_PT=reshape(dataSet.data.S22,8,size(E,1))';
                D33_PT=reshape(dataSet.data.S33,8,size(E,1))';
                D12_PT=reshape(dataSet.data.S12,8,size(E,1))';
                D13_PT=reshape(dataSet.data.S13,8,size(E,1))';
                D23_PT=reshape(dataSet.data.S23,8,size(E,1))';
            <span class="keyword">case</span> 2
                <span class="comment">% Get element data across all 8 integration points</span>
                D11_PT=reshape(dataSet.data.E11,8,size(E,1))';
                D22_PT=reshape(dataSet.data.E22,8,size(E,1))';
                D33_PT=reshape(dataSet.data.E33,8,size(E,1))';
                D12_PT=reshape(dataSet.data.E12,8,size(E,1))';
                D13_PT=reshape(dataSet.data.E13,8,size(E,1))';
                D23_PT=reshape(dataSet.data.E23,8,size(E,1))';
        <span class="keyword">end</span>

        <span class="comment">% Get mean element metrics</span>
        D11=mean(D11_PT,2);
        D22=mean(D22_PT,2);
        D33=mean(D33_PT,2);
        D12=mean(D12_PT,2);
        D13=mean(D13_PT,2);
        D23=mean(D23_PT,2);

        <span class="comment">% Calculate effective (Von Mises) metrics</span>
        <span class="keyword">switch</span> d
            <span class="keyword">case</span> 1
                E_effectiveStress(:,q+1)=(1/sqrt(2)).*sqrt((D11-D22).^2+(D11-D33).^2+(D33-D11).^2+6*D12.^2+6*D23.^2+6*D13.^2);
            <span class="keyword">case</span> 2
                E_effectiveStrain(:,q+1)=(1/sqrt(2)).*sqrt((D11-D22).^2+(D11-D33).^2+(D33-D11).^2+6*D12.^2+6*D23.^2+6*D13.^2);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">% diff(E_effectiveStress,1,2)./diff(E_effectiveStrain,1,2)</span>
</pre><p>Plotting the simulated results using <tt>anim8</tt> to visualize and animate deformations</p><pre class="codeinput"><span class="comment">%Getting final nodal coordinates</span>
V_def=[abaqusData.STEP(1).INCREMENT(end).nodeOutput(1).data.COOR1<span class="keyword">...</span>
    abaqusData.STEP(1).INCREMENT(end).nodeOutput(1).data.COOR2<span class="keyword">...</span>
    abaqusData.STEP(1).INCREMENT(end).nodeOutput(1).data.COOR3];
U=V_def-V; <span class="comment">%Displacements</span>

colorDataVertices=sqrt(sum(U.^2,2)); <span class="comment">%Displacement magnitude data for coloring</span>

timeVec=[0 abaqusData.STEP(1).INCREMENT(:).TOTAL_TIME_COMPLETED];

<span class="comment">% Get limits for plotting</span>
minV=min([V;V_def],[],1); <span class="comment">%Minima</span>
maxV=max([V;V_def],[],1); <span class="comment">%Maxima</span>

<span class="comment">% Create basic view and store graphics handle to initiate animation</span>
hf=cFigure; <span class="comment">%Open figure</span>
gtitle([abaqusInpFileNamePart,<span class="string">': Displacement data. Press play to animate'</span>]);
hp=gpatch(Fb,V_def,colorDataVertices,<span class="string">'k'</span>,1); <span class="comment">%Add graphics object to animate</span>
gpatch(Fb,V,0.5*ones(1,3),<span class="string">'k'</span>,0.25); <span class="comment">%A static graphics object</span>
axisGeom(gca,fontSize);
colormap(gjet(250)); colorbar;
caxis([0 max(colorDataVertices)]);
axis([minV(1) maxV(1) minV(2) maxV(2) minV(3) maxV(3)]); <span class="comment">%Set axis limits statically</span>
view(130,25); <span class="comment">%Set view direction</span>
camlight <span class="string">headlight</span>;

<span class="comment">% Set up animation features</span>
animStruct.Time=timeVec; <span class="comment">%The time vector</span>
<span class="keyword">for</span> qt=1:1:numel(timeVec) <span class="comment">%Loop over time increments</span>
    <span class="keyword">if</span> qt&gt;1
        V_def=[abaqusData.STEP(1).INCREMENT(qt-1).nodeOutput.data.COOR1<span class="keyword">...</span>
            abaqusData.STEP(1).INCREMENT(qt-1).nodeOutput.data.COOR2<span class="keyword">...</span>
            abaqusData.STEP(1).INCREMENT(qt-1).nodeOutput.data.COOR3];
    <span class="keyword">else</span>
        V_def=V;
    <span class="keyword">end</span>
    U=V_def-V; <span class="comment">%Displacements</span>
    colorDataVertices=sqrt(sum(U(:,3).^2,2)); <span class="comment">%New color data</span>

    <span class="comment">%Set entries in animation structure</span>
    animStruct.Handles{qt}=[hp hp]; <span class="comment">%Handles of objects to animate</span>
    animStruct.Props{qt}={<span class="string">'Vertices'</span>,<span class="string">'CData'</span>}; <span class="comment">%Properties of objects to animate</span>
    animStruct.Set{qt}={V_def,colorDataVertices}; <span class="comment">%Property values for to set in order to animate</span>
<span class="keyword">end</span>
anim8(hf,animStruct); <span class="comment">%Initiate animation feature</span>
drawnow;
</pre><p>Plotting the simulated results using <tt>anim8</tt> to visualize and animate deformations</p><pre class="codeinput"><span class="comment">%Getting final nodal coordinates</span>
V_def=[abaqusData.STEP(1).INCREMENT(end).nodeOutput.data.COOR1<span class="keyword">...</span>
    abaqusData.STEP(1).INCREMENT(end).nodeOutput.data.COOR2<span class="keyword">...</span>
    abaqusData.STEP(1).INCREMENT(end).nodeOutput.data.COOR3];
U=V_def-V; <span class="comment">%Displacements</span>

[FE,C_FE_effectiveStress]=element2patch(E,E_effectiveStress(:,end),<span class="string">'hex8'</span>);
[indBoundary]=tesBoundary(FE,V);
FEb=FE(indBoundary,:);
colorDataFaces=C_FE_effectiveStress(indBoundary);

timeVec=[0 abaqusData.STEP(1).INCREMENT(:).TOTAL_TIME_COMPLETED];

<span class="comment">% Get limits for plotting</span>
minV=min([V;V_def],[],1); <span class="comment">%Minima</span>
maxV=max([V;V_def],[],1); <span class="comment">%Maxima</span>

<span class="comment">% Create basic view and store graphics handle to initiate animation</span>
hf=cFigure; <span class="comment">%Open figure</span>
gtitle([abaqusInpFileNamePart,<span class="string">': Effective stress data. Press play to animate'</span>]);
hp=gpatch(FEb,V_def,colorDataFaces,<span class="string">'k'</span>,1); <span class="comment">%Add graphics object to animate</span>
gpatch(FEb,V,0.5*ones(1,3),<span class="string">'k'</span>,0.25); <span class="comment">%A static graphics object</span>
axisGeom(gca,fontSize);
colormap(gjet(250)); colorbar;
caxis([0 max(E_effectiveStress(:))]);
axis([minV(1) maxV(1) minV(2) maxV(2) minV(3) maxV(3)]); <span class="comment">%Set axis limits statically</span>
view(130,25); <span class="comment">%Set view direction</span>
camlight <span class="string">headlight</span>;

<span class="comment">% Set up animation features</span>
animStruct.Time=timeVec; <span class="comment">%The time vector</span>
<span class="keyword">for</span> qt=1:1:numel(timeVec) <span class="comment">%Loop over time increments</span>
    <span class="keyword">if</span> qt&gt;1
        V_def=[abaqusData.STEP(1).INCREMENT(qt-1).nodeOutput.data.COOR1<span class="keyword">...</span>
            abaqusData.STEP(1).INCREMENT(qt-1).nodeOutput.data.COOR2<span class="keyword">...</span>
            abaqusData.STEP(1).INCREMENT(qt-1).nodeOutput.data.COOR3];
    <span class="keyword">else</span>
        V_def=V;
    <span class="keyword">end</span>
    U=V_def-V; <span class="comment">%Displacements</span>

    [~,C_FE_effectiveStress]=element2patch(E,E_effectiveStress(:,qt),<span class="string">'hex8'</span>);
    colorDataFaces=C_FE_effectiveStress(indBoundary); <span class="comment">%New color data</span>

    <span class="comment">%Set entries in animation structure</span>
    animStruct.Handles{qt}=[hp hp]; <span class="comment">%Handles of objects to animate</span>
    animStruct.Props{qt}={<span class="string">'Vertices'</span>,<span class="string">'CData'</span>}; <span class="comment">%Properties of objects to animate</span>
    animStruct.Set{qt}={V_def,colorDataFaces}; <span class="comment">%Property values for to set in order to animate</span>
<span class="keyword">end</span>
anim8(hf,animStruct); <span class="comment">%Initiate animation feature</span>
drawnow;
</pre><p><img vspace="5" hspace="5" src="gibbVerySmall.gif" alt=""> </p><p><i><b>GIBBON</b></i> <a href="www.gibboncode.org">www.gibboncode.org</a></p><p><i>Kevin Mattheus Moerman</i>, <a href="gibbon.toolbox@gmail.com">gibbon.toolbox@gmail.com</a></p><p><i><b>GIBBON footer text</b></i></p><p>License: <a href="https://github.com/gibbonCode/GIBBON/blob/master/LICENSE">https://github.com/gibbonCode/GIBBON/blob/master/LICENSE</a></p><p>GIBBON: The Geometry and Image-based Bioengineering add-On. A toolbox for image segmentation, image-based modeling, meshing, and finite element analysis.</p><p>Copyright (C) 2006-2022 Kevin Mattheus Moerman and the GIBBON contributors</p><p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p><p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.</p><p>You should have received a copy of the GNU General Public License along with this program.  If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.</p><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2022b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% DEMO_abaqus_0001_cube_uniaxial
% Below is a demonstration for:
%
% * Building geometry for a cube with hexahedral elements
% * Defining the boundary conditions
% * Coding the abaqus structure
% * Running the model
% * Importing and visualizing the displacement and stress results

%% Keywords
%
% * abaqus
% * uniaxial loading
% * compression, tension, compressive, tensile
% * displacement control, displacement boundary condition
% * hexahedral elements, hex8
% * cube, box, rectangular
% * static, solid
% * hyperelastic, Ogden
% * displacement logfile
% * stress logfile

%%

clear; close all; clc;

%% Plot settings
fontSize=20;
faceAlpha1=0.8;
markerSize=40;
lineWidth=3;

%% Control parameters

% Path names
defaultFolder = fileparts(fileparts(mfilename('fullpath')));
savePath=fullfile(defaultFolder,'data','temp');

% Defining file names
abaqusInpFileNamePart='tempModel';
abaqusInpFileName=fullfile(savePath,[abaqusInpFileNamePart,'.inp']); %INP file name
abaqusDATFileName=fullfile(savePath,[abaqusInpFileNamePart,'.dat']); %DAT file name

%Specifying dimensions and number of elements
cubeSize=10;
sampleWidth=cubeSize; %Width
sampleThickness=cubeSize; %Thickness
sampleHeight=cubeSize; %Height
pointSpacings=2*ones(1,3); %Desired point spacing between nodes
numElementsWidth=round(sampleWidth/pointSpacings(1)); %Number of elemens in dir 1
numElementsThickness=round(sampleThickness/pointSpacings(2)); %Number of elemens in dir 2
numElementsHeight=round(sampleHeight/pointSpacings(3)); %Number of elemens in dir 3

%Define applied displacement
appliedStrain=0.3; %Linear strain (Only used to compute applied stretch)
loadingOption='compression'; % or 'tension'
switch loadingOption
    case 'compression'
        stretchLoad=1-appliedStrain; %The applied stretch for uniaxial loading
    case 'tension'
        stretchLoad=1+appliedStrain; %The applied stretch for uniaxial loading
end
displacementMagnitude=(stretchLoad*sampleHeight)-sampleHeight; %The displacement magnitude

%Material parameter set
E_youngs=1e-3;
v_poisson=0.4;

%% Creating model geometry and mesh
% A box is created with tri-linear hexahedral (hex8) elements using the
% |hexMeshBox| function. The function offers the boundary faces with
% seperate labels for the top, bottom, left, right, front, and back sides.
% As such these can be used to define boundary conditions on the exterior.

% Create a box with hexahedral elements
cubeDimensions=[sampleWidth sampleThickness sampleHeight]; %Dimensions
cubeElementNumbers=[numElementsWidth numElementsThickness numElementsHeight]; %Number of elements
outputStructType=2; %A structure compatible with mesh view
[meshStruct]=hexMeshBox(cubeDimensions,cubeElementNumbers,outputStructType);

%Access elements, nodes, and faces from the structure
E=meshStruct.elements; %The elements
V=meshStruct.nodes; %The nodes (vertices)
Fb=meshStruct.facesBoundary; %The boundary faces
Cb=meshStruct.boundaryMarker; %The "colors" or labels for the boundary faces
elementMaterialIndices=ones(size(E,1),1); %Element material indices

%%
% Plotting model boundary surfaces and a cut view

hFig=cFigure;

subplot(1,2,1); hold on;
title('Model boundary surfaces and labels','FontSize',fontSize);
gpatch(Fb,V,Cb,'k',faceAlpha1);
colormap(gjet(6)); icolorbar;
axisGeom(gca,fontSize);

hs=subplot(1,2,2); hold on;
title('Cut view of solid mesh','FontSize',fontSize);
optionStruct.hFig=[hFig hs];
meshView(meshStruct,optionStruct);
axisGeom(gca,fontSize);

drawnow;

%% Defining the boundary conditions
% The visualization of the model boundary shows colors for each side of the
% cube. These labels can be used to define boundary conditions.

%Define supported node sets
logicFace=Cb==1; %Logic for current face set
Fr=Fb(logicFace,:); %The current face set
bcSupportList_X=unique(Fr(:)); %Node set part of selected face

logicFace=Cb==3; %Logic for current face set
Fr=Fb(logicFace,:); %The current face set
bcSupportList_Y=unique(Fr(:)); %Node set part of selected face

logicFace=Cb==5; %Logic for current face set
Fr=Fb(logicFace,:); %The current face set
bcSupportList_Z=unique(Fr(:)); %Node set part of selected face

%Prescribed displacement nodes
logicPrescribe=Cb==6; %Logic for current face set
Fr=Fb(logicPrescribe,:); %The current face set
bcPrescribeList=unique(Fr(:)); %Node set part of selected face

%%
% Visualizing boundary conditions. Markers plotted on the semi-transparent
% model denote the nodes in the various boundary condition lists.

hf=cFigure;
title('Boundary conditions','FontSize',fontSize);
xlabel('X','FontSize',fontSize); ylabel('Y','FontSize',fontSize); zlabel('Z','FontSize',fontSize);
hold on;

gpatch(Fb,V,'kw','k',0.5);

hl(1)=plotV(V(bcSupportList_X,:),'r.','MarkerSize',markerSize);
hl(2)=plotV(V(bcSupportList_Y,:),'g+','MarkerSize',markerSize*2);
hl(3)=plotV(V(bcSupportList_Z,:),'b*','MarkerSize',markerSize);
hl(4)=plotV(V(bcPrescribeList,:),'ko','MarkerSize',markerSize);

legend(hl,{'BC x support','BC y support','BC z support','BC z prescribe'});

axisGeom(gca,fontSize);
camlight headlight;
drawnow;

%% Defining the abaqus input structure
% See also |abaqusStructTemplate| and |abaqusStruct2inp| and the abaqus user
% manual.

%%REPLACE_WITH_DASH_DASH> Heading
abaqus_spec.Heading.COMMENT{1}='Job name: ABAQUS inp file creation demo';
abaqus_spec.Heading.COMMENT{2}='Generated by: GIBBON';

%%REPLACE_WITH_DASH_DASH> Preprint
abaqus_spec.Preprint.ATTR.echo='NO';
abaqus_spec.Preprint.ATTR.model='NO';
abaqus_spec.Preprint.ATTR.history='NO';
abaqus_spec.Preprint.ATTR.contact='NO';

%REPLACE_WITH_DASH_DASH> Part

% Node
nodeIds=(1:1:size(V,1))';
abaqus_spec.Part.COMMENT='This section defines the part geometry in terms of nodes and elements';
abaqus_spec.Part.ATTR.name='Cube';
abaqus_spec.Part.Node={nodeIds,V};

% Element
elementIds=(1:1:size(E,1));
abaqus_spec.Part.Element{1}.ATTR.type='C3D8';%'C3D8R';
abaqus_spec.Part.Element{1}.VAL={elementIds(:),E};

% Element sets
abaqus_spec.Part.Elset{1}.ATTR.elset='Set-1';
abaqus_spec.Part.Elset{1}.VAL=elementIds;

% Sections
abaqus_spec.Part.Solid_section.ATTR.elset='Set-1';
abaqus_spec.Part.Solid_section.ATTR.material='Elastic';

%%REPLACE_WITH_DASH_DASH> Assembly
abaqus_spec.Assembly.ATTR.name='Assembly-1';
abaqus_spec.Assembly.Instance.ATTR.name='Cube-assembly';
abaqus_spec.Assembly.Instance.ATTR.part='Cube';

abaqus_spec.Assembly.Nset{1}.ATTR.nset='Set-1';
abaqus_spec.Assembly.Nset{1}.ATTR.instance='Cube-assembly';
abaqus_spec.Assembly.Nset{1}.VAL=bcSupportList_X(:)';

abaqus_spec.Assembly.Nset{2}.ATTR.nset='Set-2';
abaqus_spec.Assembly.Nset{2}.ATTR.instance='Cube-assembly';
abaqus_spec.Assembly.Nset{2}.VAL=bcSupportList_Y(:)';

abaqus_spec.Assembly.Nset{3}.ATTR.nset='Set-3';
abaqus_spec.Assembly.Nset{3}.ATTR.instance='Cube-assembly';
abaqus_spec.Assembly.Nset{3}.VAL=bcSupportList_Z(:)';

abaqus_spec.Assembly.Nset{4}.ATTR.nset='Set-4';
abaqus_spec.Assembly.Nset{4}.ATTR.instance='Cube-assembly';
abaqus_spec.Assembly.Nset{4}.VAL=bcPrescribeList(:)';

abaqus_spec.Assembly.Nset{5}.ATTR.nset='all';
abaqus_spec.Assembly.Nset{5}.ATTR.instance='Cube-assembly';
abaqus_spec.Assembly.Nset{5}.VAL=1:1:size(V,1);

%%REPLACE_WITH_DASH_DASH> Material
abaqus_spec.Material.ATTR.name='Elastic';
abaqus_spec.Material.Elastic=[E_youngs v_poisson];

%%REPLACE_WITH_DASH_DASH> Step
abaqus_spec.Step.ATTR.name='Step-1';
abaqus_spec.Step.ATTR.nlgeom='YES';
abaqus_spec.Step.Static=[0.1 1 1e-5 0.1];

% Boundary
abaqus_spec.Step.Boundary{1}.VAL={'Set-1',[1,1]};
abaqus_spec.Step.Boundary{2}.VAL={'Set-2',[2,2]};
abaqus_spec.Step.Boundary{3}.VAL={'Set-3',[3,3]};
abaqus_spec.Step.Boundary{4}.VAL={'Set-4',[3,3],displacementMagnitude};

%Output
abaqus_spec.Step.Restart.ATTR.write='';
abaqus_spec.Step.Restart.ATTR.frequency=0;

abaqus_spec.Step.Output{1}.ATTR.field='';
abaqus_spec.Step.Output{1}.ATTR.variable='PRESELECT';
abaqus_spec.Step.Output{2}.ATTR.history='';
abaqus_spec.Step.Output{2}.ATTR.variable='PRESELECT';

%Nodal coordinates
abaqus_spec.Step.Node_print{1}.ATTR.nset='all';
abaqus_spec.Step.Node_print{1}.ATTR.frequency = 1;
abaqus_spec.Step.Node_print{1}.VAL='COORD';

abaqus_spec.Step.El_print{1}.VAL='S';
abaqus_spec.Step.El_print{2}.VAL='E';

%%

abaqusStruct2inp(abaqus_spec,abaqusInpFileName);

%textView(abaqusInpFileName);

%% Run the job using Abaqus

lockFileName=fullfile(savePath,[abaqusInpFileNamePart,'.lck']);
if exist(lockFileName,'file')
    warning('Lockfile found and deleted')
    delete(lockFileName);
end

%%

oldPath=pwd; %Get current working directory
cd(savePath); %Set new working directory to match save patch

abaqusPath='abaqus';%'/usr/bin/abaqus'; %Abaqus excute command or path
runFlag=system([abaqusPath,' inp="',abaqusInpFileName,'" job=',abaqusInpFileNamePart,' interactive ask_delete=OFF']);

cd(oldPath); %Restore working directory

%% Import and visualize abaqus results
% Importing the abaqus .dat file 

[abaqusData]=importAbaqusDat(abaqusDATFileName);

%% Get element data

E_effectiveStress=zeros(size(E,1),numel(abaqusData.STEP.INCREMENT)+1);
E_effectiveStrain=zeros(size(E,1),numel(abaqusData.STEP.INCREMENT)+1);
for q=1:1:numel(abaqusData.STEP.INCREMENT)
    
    for d=1:1:2        
        dataSet=abaqusData.STEP.INCREMENT(q).elementOutput(d); %Get data structure
        switch d
            case 1
                % Get element data across all 8 integration points
                D11_PT=reshape(dataSet.data.S11,8,size(E,1))';
                D22_PT=reshape(dataSet.data.S22,8,size(E,1))';
                D33_PT=reshape(dataSet.data.S33,8,size(E,1))';
                D12_PT=reshape(dataSet.data.S12,8,size(E,1))';
                D13_PT=reshape(dataSet.data.S13,8,size(E,1))';
                D23_PT=reshape(dataSet.data.S23,8,size(E,1))';
            case 2
                % Get element data across all 8 integration points
                D11_PT=reshape(dataSet.data.E11,8,size(E,1))';
                D22_PT=reshape(dataSet.data.E22,8,size(E,1))';
                D33_PT=reshape(dataSet.data.E33,8,size(E,1))';
                D12_PT=reshape(dataSet.data.E12,8,size(E,1))';
                D13_PT=reshape(dataSet.data.E13,8,size(E,1))';
                D23_PT=reshape(dataSet.data.E23,8,size(E,1))';                
        end
        
        % Get mean element metrics
        D11=mean(D11_PT,2);
        D22=mean(D22_PT,2);
        D33=mean(D33_PT,2);
        D12=mean(D12_PT,2);
        D13=mean(D13_PT,2);
        D23=mean(D23_PT,2);
        
        % Calculate effective (Von Mises) metrics
        switch d
            case 1
                E_effectiveStress(:,q+1)=(1/sqrt(2)).*sqrt((D11-D22).^2+(D11-D33).^2+(D33-D11).^2+6*D12.^2+6*D23.^2+6*D13.^2);
            case 2
                E_effectiveStrain(:,q+1)=(1/sqrt(2)).*sqrt((D11-D22).^2+(D11-D33).^2+(D33-D11).^2+6*D12.^2+6*D23.^2+6*D13.^2);
        end
    end
end

% diff(E_effectiveStress,1,2)./diff(E_effectiveStrain,1,2)

%%
% Plotting the simulated results using |anim8| to visualize and animate
% deformations

%Getting final nodal coordinates
V_def=[abaqusData.STEP(1).INCREMENT(end).nodeOutput(1).data.COOR1...
    abaqusData.STEP(1).INCREMENT(end).nodeOutput(1).data.COOR2...
    abaqusData.STEP(1).INCREMENT(end).nodeOutput(1).data.COOR3];
U=V_def-V; %Displacements

colorDataVertices=sqrt(sum(U.^2,2)); %Displacement magnitude data for coloring 

timeVec=[0 abaqusData.STEP(1).INCREMENT(:).TOTAL_TIME_COMPLETED];

% Get limits for plotting
minV=min([V;V_def],[],1); %Minima
maxV=max([V;V_def],[],1); %Maxima

% Create basic view and store graphics handle to initiate animation
hf=cFigure; %Open figure
gtitle([abaqusInpFileNamePart,': Displacement data. Press play to animate']);
hp=gpatch(Fb,V_def,colorDataVertices,'k',1); %Add graphics object to animate
gpatch(Fb,V,0.5*ones(1,3),'k',0.25); %A static graphics object
axisGeom(gca,fontSize);
colormap(gjet(250)); colorbar;
caxis([0 max(colorDataVertices)]);
axis([minV(1) maxV(1) minV(2) maxV(2) minV(3) maxV(3)]); %Set axis limits statically
view(130,25); %Set view direction
camlight headlight;

% Set up animation features
animStruct.Time=timeVec; %The time vector
for qt=1:1:numel(timeVec) %Loop over time increments    
    if qt>1
        V_def=[abaqusData.STEP(1).INCREMENT(qt-1).nodeOutput.data.COOR1...
            abaqusData.STEP(1).INCREMENT(qt-1).nodeOutput.data.COOR2...
            abaqusData.STEP(1).INCREMENT(qt-1).nodeOutput.data.COOR3];
    else
        V_def=V;
    end    
    U=V_def-V; %Displacements
    colorDataVertices=sqrt(sum(U(:,3).^2,2)); %New color data
   
    %Set entries in animation structure
    animStruct.Handles{qt}=[hp hp]; %Handles of objects to animate
    animStruct.Props{qt}={'Vertices','CData'}; %Properties of objects to animate
    animStruct.Set{qt}={V_def,colorDataVertices}; %Property values for to set in order to animate
end
anim8(hf,animStruct); %Initiate animation feature
drawnow;

%%
% Plotting the simulated results using |anim8| to visualize and animate
% deformations

%Getting final nodal coordinates
V_def=[abaqusData.STEP(1).INCREMENT(end).nodeOutput.data.COOR1...
    abaqusData.STEP(1).INCREMENT(end).nodeOutput.data.COOR2...
    abaqusData.STEP(1).INCREMENT(end).nodeOutput.data.COOR3];
U=V_def-V; %Displacements

[FE,C_FE_effectiveStress]=element2patch(E,E_effectiveStress(:,end),'hex8');
[indBoundary]=tesBoundary(FE,V);
FEb=FE(indBoundary,:);
colorDataFaces=C_FE_effectiveStress(indBoundary); 

timeVec=[0 abaqusData.STEP(1).INCREMENT(:).TOTAL_TIME_COMPLETED];

% Get limits for plotting
minV=min([V;V_def],[],1); %Minima
maxV=max([V;V_def],[],1); %Maxima

% Create basic view and store graphics handle to initiate animation
hf=cFigure; %Open figure
gtitle([abaqusInpFileNamePart,': Effective stress data. Press play to animate']);
hp=gpatch(FEb,V_def,colorDataFaces,'k',1); %Add graphics object to animate
gpatch(FEb,V,0.5*ones(1,3),'k',0.25); %A static graphics object
axisGeom(gca,fontSize);
colormap(gjet(250)); colorbar;
caxis([0 max(E_effectiveStress(:))]);
axis([minV(1) maxV(1) minV(2) maxV(2) minV(3) maxV(3)]); %Set axis limits statically
view(130,25); %Set view direction
camlight headlight;

% Set up animation features
animStruct.Time=timeVec; %The time vector
for qt=1:1:numel(timeVec) %Loop over time increments    
    if qt>1
        V_def=[abaqusData.STEP(1).INCREMENT(qt-1).nodeOutput.data.COOR1...
            abaqusData.STEP(1).INCREMENT(qt-1).nodeOutput.data.COOR2...
            abaqusData.STEP(1).INCREMENT(qt-1).nodeOutput.data.COOR3];
    else
        V_def=V;
    end    
    U=V_def-V; %Displacements
    
    [~,C_FE_effectiveStress]=element2patch(E,E_effectiveStress(:,qt),'hex8');
    colorDataFaces=C_FE_effectiveStress(indBoundary); %New color data
   
    %Set entries in animation structure
    animStruct.Handles{qt}=[hp hp]; %Handles of objects to animate
    animStruct.Props{qt}={'Vertices','CData'}; %Properties of objects to animate
    animStruct.Set{qt}={V_def,colorDataFaces}; %Property values for to set in order to animate
end
anim8(hf,animStruct); %Initiate animation feature
drawnow;

%%
%
% <<gibbVerySmall.gif>>
%
% _*GIBBON*_
% <www.gibboncode.org>
%
% _Kevin Mattheus Moerman_, <gibbon.toolbox@gmail.com>

%% 
% _*GIBBON footer text*_ 
% 
% License: <https://github.com/gibbonCode/GIBBON/blob/master/LICENSE>
% 
% GIBBON: The Geometry and Image-based Bioengineering add-On. A toolbox for
% image segmentation, image-based modeling, meshing, and finite element
% analysis.
% 
% Copyright (C) 2006-2022 Kevin Mattheus Moerman and the GIBBON contributors
% 
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.

##### SOURCE END #####
--></body></html>
